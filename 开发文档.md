# WebRecord é¡¹ç›®å¼€å‘æ–‡æ¡£

![](https://img.shields.io/badge/Version-3.0-green?style=flat-square)

## é¡¹ç›®æ¦‚è¿°

WebRecord æ˜¯ä¸€ä¸ªåŸºäº WebRTC æŠ€æœ¯çš„æµè§ˆå™¨ç«¯å½•åˆ¶ç³»ç»Ÿï¼Œä¸»è¦ç”¨äºåœ¨çº¿è€ƒè¯•ç›‘æ§ã€‚ç³»ç»Ÿæ”¯æŒå±å¹•å½•åˆ¶ã€æ‘„åƒå¤´å½•åˆ¶ã€å®æ—¶ç›‘æ§å’ŒæœåŠ¡å™¨ç«¯å®æ—¶ä¿å­˜ç­‰åŠŸèƒ½ã€‚é¡¹ç›®é‡‡ç”¨ Node.js + Express + Socket.IO + WebRTC æŠ€æœ¯æ ˆå¼€å‘ã€‚

### ä¸»è¦åŠŸèƒ½
- ğŸ¥ **å±å¹•å½•åˆ¶**: æ”¯æŒé«˜æ¸…å±å¹•å½•åˆ¶ï¼Œå¯é…ç½®åˆ†è¾¨ç‡å’Œå¸§ç‡
- ğŸ“¹ **æ‘„åƒå¤´å½•åˆ¶**: æ”¯æŒæ‘„åƒå¤´å½•åˆ¶åŠŸèƒ½
- ğŸ‘€ **å®æ—¶ç›‘æ§**: ç®¡ç†å‘˜å¯å®æ—¶æŸ¥çœ‹å­¦ç”Ÿå½•åˆ¶çŠ¶æ€
- ğŸ’¾ **è‡ªåŠ¨ä¿å­˜**: å½•åˆ¶å†…å®¹è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
- ğŸ” **æƒé™ç®¡ç†**: æ”¯æŒå­¦ç”Ÿå’Œç®¡ç†å‘˜ä¸¤ç§è§’è‰²
- ğŸ“Š **çŠ¶æ€ç›‘æ§**: å®æ—¶æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€ã€å½•åˆ¶çŠ¶æ€ã€ä¸­æ–­æ¬¡æ•°ç­‰
- ğŸ”” **é€šçŸ¥ç³»ç»Ÿ**: æ”¯æŒå…¨ä½“æˆ–å•ä¸ªç”¨æˆ·é€šçŸ¥
- â° **è€ƒè¯•ç®¡ç†**: æ”¯æŒè€ƒè¯•æ—¶é—´æ§åˆ¶å’Œå­¦ç”Ÿç®¡ç†

## æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ
- **Node.js**: è¿è¡Œæ—¶ç¯å¢ƒ
- **Express.js**: Web æ¡†æ¶
- **Socket.IO**: å®æ—¶é€šä¿¡
- **MySQL/MariaDB**: æ•°æ®åº“
- **Redis**: Session å­˜å‚¨
- **HTTPS**: å®‰å…¨ä¼ è¾“
- **PeerJS**: WebRTC è¿æ¥ç®¡ç†
- **Coturn**: TURN/STUN æœåŠ¡å™¨

### å‰ç«¯æŠ€æœ¯æ ˆ
- **HTML5**: é¡µé¢ç»“æ„
- **Bootstrap 5**: UI æ¡†æ¶
- **JavaScript ES6+**: ä¸šåŠ¡é€»è¾‘
- **WebRTC API**: åª’ä½“å½•åˆ¶
- **Socket.IO Client**: å®æ—¶é€šä¿¡
- **Art-template**: æ¨¡æ¿å¼•æ“

### ç³»ç»Ÿæ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å­¦ç”Ÿç«¯æµè§ˆå™¨   â”‚    â”‚   ç®¡ç†å‘˜æµè§ˆå™¨   â”‚    â”‚   TURNæœåŠ¡å™¨    â”‚
â”‚                â”‚    â”‚                â”‚    â”‚   (Coturn)     â”‚
â”‚ - å½•åˆ¶ç•Œé¢      â”‚    â”‚ - ç›‘æ§ç•Œé¢      â”‚    â”‚                â”‚
â”‚ - WebRTCå½•åˆ¶    â”‚    â”‚ - å®æ—¶æŸ¥çœ‹      â”‚    â”‚ - NATç©¿é€      â”‚
â”‚ - Socketè¿æ¥    â”‚    â”‚ - å­¦ç”Ÿç®¡ç†      â”‚    â”‚ - ä¸­ç»§æœåŠ¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     WebRecordæœåŠ¡å™¨      â”‚
                    â”‚                        â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚    Expressåº”ç”¨      â”‚ â”‚
                    â”‚ â”‚ - è·¯ç”±å¤„ç†          â”‚ â”‚
                    â”‚ â”‚ - è®¤è¯ä¸­é—´ä»¶        â”‚ â”‚
                    â”‚ â”‚ - é™æ€æ–‡ä»¶æœåŠ¡      â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚   Socket.IOæœåŠ¡     â”‚ â”‚
                    â”‚ â”‚ - å®æ—¶é€šä¿¡          â”‚ â”‚
                    â”‚ â”‚ - çŠ¶æ€åŒæ­¥          â”‚ â”‚
                    â”‚ â”‚ - æ–‡ä»¶ä¼ è¾“          â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚    ä¸šåŠ¡æœåŠ¡å±‚       â”‚ â”‚
                    â”‚ â”‚ - ç”¨æˆ·ç®¡ç†          â”‚ â”‚
                    â”‚ â”‚ - å½•åˆ¶ç®¡ç†          â”‚ â”‚
                    â”‚ â”‚ - æ–‡ä»¶ç®¡ç†          â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      æ•°æ®å­˜å‚¨å±‚         â”‚
                    â”‚                        â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚ MySQL   â”‚ â”‚ Redis   â”‚ â”‚
                    â”‚ â”‚ ç”¨æˆ·æ•°æ® â”‚ â”‚ Session â”‚ â”‚
                    â”‚ â”‚ æ—¥å¿—è®°å½• â”‚ â”‚ ç¼“å­˜    â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚     æ–‡ä»¶ç³»ç»Ÿ        â”‚ â”‚
                    â”‚ â”‚   å½•åˆ¶æ–‡ä»¶å­˜å‚¨      â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é¡¹ç›®ç»“æ„

```
WebRTC/
â”œâ”€â”€ app.js                    # åº”ç”¨ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ package.json              # é¡¹ç›®ä¾èµ–é…ç½®
â”œâ”€â”€ config.js                 # ç³»ç»Ÿé…ç½®æ–‡ä»¶
â”œâ”€â”€ config_example.js         # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”œâ”€â”€ turnserver.conf           # TURNæœåŠ¡å™¨é…ç½®
â”œâ”€â”€ turnserver_example.conf   # TURNé…ç½®æ¨¡æ¿
â”œâ”€â”€ database.sql              # æ•°æ®åº“ç»“æ„
â”œâ”€â”€ user.sql                  # ç”¨æˆ·è¡¨ç»“æ„
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ æ³¨æ„äº‹é¡¹.txt              # éƒ¨ç½²æ³¨æ„äº‹é¡¹
â”‚
â”œâ”€â”€ ssl/                      # SSLè¯ä¹¦ç›®å½•
â”‚   â”œâ”€â”€ cert.crt             # SSLè¯ä¹¦
â”‚   â””â”€â”€ private.key          # ç§é’¥
â”‚
â”œâ”€â”€ routes/                   # è·¯ç”±æ¨¡å—
â”‚   â”œâ”€â”€ pages.js             # é¡µé¢è·¯ç”±
â”‚   â”œâ”€â”€ api.js               # APIè·¯ç”±
â”‚   â”œâ”€â”€ auth.js              # è®¤è¯è·¯ç”±
â”‚   â””â”€â”€ files.js             # æ–‡ä»¶è·¯ç”±
â”‚
â”œâ”€â”€ services/                 # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ database.js          # æ•°æ®åº“æœåŠ¡
â”‚   â”œâ”€â”€ socketHandler.js     # Socketå¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ userManager.js       # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ utils.js             # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ middleware/               # ä¸­é—´ä»¶
â”‚   â””â”€â”€ auth.js              # è®¤è¯ä¸­é—´ä»¶
â”‚
â”œâ”€â”€ views/                    # å‰ç«¯é¡µé¢
â”‚   â”œâ”€â”€ template.html        # é¡µé¢æ¨¡æ¿
â”‚   â”œâ”€â”€ index.html           # é¦–é¡µ
â”‚   â”œâ”€â”€ login.html           # ç™»å½•é¡µ
â”‚   â”œâ”€â”€ record.html          # å½•åˆ¶é¡µ
â”‚   â”œâ”€â”€ monitor.html         # ç›‘æ§é¡µ
â”‚   â”œâ”€â”€ video.html           # è§†é¢‘æŸ¥çœ‹é¡µ
â”‚   â”œâ”€â”€ history.html         # å†å²è®°å½•é¡µ
â”‚   â”œâ”€â”€ password.html        # å¯†ç ä¿®æ”¹é¡µ
â”‚   â””â”€â”€ monitor_file.html    # æ–‡ä»¶ç›‘æ§é¡µ
â”‚
â”œâ”€â”€ js/                       # å‰ç«¯JavaScript
â”‚   â”œâ”€â”€ record.js            # å½•åˆ¶åŠŸèƒ½è„šæœ¬
â”‚   â”œâ”€â”€ controller.js        # ç›‘æ§æ§åˆ¶è„šæœ¬
â”‚   â”œâ”€â”€ login.js             # ç™»å½•è„šæœ¬
â”‚   â””â”€â”€ change.js            # å¯†ç ä¿®æ”¹è„šæœ¬
â”‚
â”œâ”€â”€ images/                   # é™æ€å›¾ç‰‡èµ„æº
â”œâ”€â”€ assets/                   # å…¶ä»–é™æ€èµ„æº
â”œâ”€â”€ docs/                     # é¡¹ç›®æ–‡æ¡£
â”‚   â””â”€â”€ WebRTC-Protocol-Documentation.md
â””â”€â”€ node_modules/             # ä¾èµ–åŒ…ç›®å½•
```

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. åº”ç”¨å…¥å£ (app.js)

åº”ç”¨çš„ä¸»å…¥å£æ–‡ä»¶ï¼Œè´Ÿè´£ï¼š
- åˆ›å»º HTTPS æœåŠ¡å™¨
- é…ç½® Express åº”ç”¨
- è®¾ç½® Socket.IO æœåŠ¡
- åˆå§‹åŒ– WebRTC æœåŠ¡
- é…ç½®è·¯ç”±å’Œä¸­é—´ä»¶
- é”™è¯¯å¤„ç†

å…³é”®åŠŸèƒ½ï¼š
```javascript
// åˆ›å»ºHTTPSæœåŠ¡å™¨
const server = https.createServer({
    key: fs.readFileSync(serverConfig.keyPath),
    cert: fs.readFileSync(serverConfig.certPath)
}, app);

// Socket.IOé…ç½®
const io = new Server(server, {
    pingInterval: 10000,
    pingTimeout: 60000,
    maxHttpBufferSize: 1e8  // 100MBæ–‡ä»¶ä¸Šä¼ é™åˆ¶
});
```

### 2. æ•°æ®åº“æœåŠ¡ (services/database.js)

æä¾›æ•°æ®åº“æ“ä½œæ¥å£ï¼š
- ç”¨æˆ·ç®¡ç†ï¼šè·å–ç”¨æˆ·ä¿¡æ¯ã€æ›´æ–°ç”¨æˆ·çŠ¶æ€
- æ—¥å¿—è®°å½•ï¼šè®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—
- ç›‘æ§ç®¡ç†ï¼šè·å–ç›‘æ§å­¦ç”Ÿåˆ—è¡¨
- è€ƒè¯•ç®¡ç†ï¼šè€ƒè¯•å­¦ç”Ÿç®¡ç†æ“ä½œ

ä¸»è¦å‡½æ•°ï¼š
```javascript
// æ·»åŠ æ“ä½œæ—¥å¿—
const addLog = async (user, ipaddr, type, content, second = 0)

// è·å–æ‰€æœ‰å¯ç”¨ç”¨æˆ·
const getAllUsers = async ()

// æ ¹æ®IDè·å–ç”¨æˆ·
const getUserById = async (id)

// è·å–ç›‘æ§å­¦ç”Ÿåˆ—è¡¨
const getMonitorStuList = async (monitorId, status)
```

### 3. Socketå¤„ç†æœåŠ¡ (services/socketHandler.js)

å¤„ç†å®æ—¶é€šä¿¡é€»è¾‘ï¼š
- è¿æ¥ç®¡ç†ï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥å’Œæ–­å¼€
- å½•åˆ¶æ§åˆ¶ï¼šå¤„ç†å½•åˆ¶å¼€å§‹ã€åœæ­¢ã€ä¸­æ–­
- ç›‘æ§åŠŸèƒ½ï¼šå¤„ç†å®æ—¶ç›‘æ§è¿æ¥
- æ–‡ä»¶ä¼ è¾“ï¼šå¤„ç†å½•åˆ¶æ–‡ä»¶ä¸Šä¼ 
- çŠ¶æ€åŒæ­¥ï¼šåŒæ­¥ç”¨æˆ·çŠ¶æ€åˆ°æ‰€æœ‰å®¢æˆ·ç«¯

æ ¸å¿ƒäº‹ä»¶å¤„ç†ï¼š
```javascript
// æ¶ˆæ¯äº‹ä»¶ - å¤„ç†å½•åˆ¶çŠ¶æ€å˜åŒ–
socket.on('message', async (srcId, type, args, callback) => {
    // å¤„ç†åœ¨çº¿çŠ¶æ€ã€å½•åˆ¶å¼€å§‹/åœæ­¢
});

// ç›‘æ§äº‹ä»¶ - å¤„ç†å®æ—¶ç›‘æ§
socket.on('watch', async (srcId, dstId) => {
    // å»ºç«‹ç›‘æ§è¿æ¥
});

// æ–‡ä»¶äº‹ä»¶ - å¤„ç†å½•åˆ¶æ–‡ä»¶ä¸Šä¼ 
socket.on('file', async (srcId, type, device, time, data) => {
    // ä¿å­˜å½•åˆ¶æ–‡ä»¶ç‰‡æ®µ
});
```

### 4. ç”¨æˆ·ç®¡ç†æœåŠ¡ (services/userManager.js)

ç®¡ç†ç”¨æˆ·çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸï¼š
- ç”¨æˆ·åˆå§‹åŒ–ï¼šä»æ•°æ®åº“åŠ è½½ç”¨æˆ·å¹¶åˆ›å»ºå­˜å‚¨ç›®å½•
- çŠ¶æ€ç®¡ç†ï¼šç»´æŠ¤ç”¨æˆ·åœ¨çº¿çŠ¶æ€ã€å½•åˆ¶çŠ¶æ€ç­‰
- æ—¶é—´æ£€æŸ¥ï¼šç›‘æ§è€ƒè¯•ç»“æŸæ—¶é—´
- ç”¨æˆ·æ“ä½œï¼šæ·»åŠ ã€åˆ é™¤ã€æ›´æ–°ç”¨æˆ·çŠ¶æ€

ç”¨æˆ·çŠ¶æ€ç»“æ„ï¼š
```javascript
AllUsers[userId] = {
    stu_no: string,              // å­¦å·
    stu_cno: string,             // è¯¾ç¨‹å·
    stu_name: string,            // å§“å
    stu_grade: string,           // å¹´çº§
    stu_userlevel: string,       // ç”¨æˆ·çº§åˆ« ('1'=ç®¡ç†å‘˜)
    stu_class_sname: string,     // ç­çº§åç§°
    watchList: {},               // è¢«ç›‘æ§åˆ—è¡¨
    recordList: {                // å½•åˆ¶çŠ¶æ€åˆ—è¡¨
        camera: {},              // æ‘„åƒå¤´å½•åˆ¶
        screen: {}               // å±å¹•å½•åˆ¶
    },
    online: number,              // åœ¨çº¿è¿æ¥æ•°
    screenNumber: number,        // å±å¹•æ•°é‡
    interruptions: number,       // ä¸­æ–­æ¬¡æ•°
    accumulatedDuration: number, // ç´¯è®¡å½•åˆ¶æ—¶é•¿(æ¯«ç§’)
    lastStartTime: number        // æœ€åå¼€å§‹æ—¶é—´
};
```

### 5. è®¤è¯ä¸­é—´ä»¶ (middleware/auth.js)

æä¾›ä¸‰ç§è®¤è¯çº§åˆ«ï¼š
- `auth`: åŸºç¡€è®¤è¯ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
- `opAuth`: ç®¡ç†å‘˜è®¤è¯ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜ç”¨æˆ·
- `noAuth`: æœªè®¤è¯æ£€æŸ¥ï¼Œç”¨äºç™»å½•é¡µé¢

è®¤è¯æµç¨‹ï¼š
```javascript
// æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
const auth = async (req, res, next) => {
    const user = await getUser(req);
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®æ”¹å¯†ç ï¼ˆé»˜è®¤å¯†ç ï¼‰
    return user ? (cryptPwd(user.stu_no) === user.stu_password &&
                   req.path !== '/password' && req.path !== '/logout' ?
                   res.redirect('/password') : next()) :
                   res.redirect('/login');
};
```

## å‰ç«¯æ¶æ„

### 1. å½•åˆ¶é¡µé¢ (views/record.html + js/record.js)

å­¦ç”Ÿç«¯ä¸»è¦åŠŸèƒ½é¡µé¢ï¼š
- **è¿æ¥çŠ¶æ€æ˜¾ç¤º**: æ˜¾ç¤ºä¸æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€
- **å½•åˆ¶æ§åˆ¶**: å±å¹•å½•åˆ¶å’Œæ‘„åƒå¤´å½•åˆ¶çš„å¼€å§‹/åœæ­¢
- **å®æ—¶çŠ¶æ€**: æ˜¾ç¤ºå½“å‰å½•åˆ¶çŠ¶æ€
- **é€šçŸ¥æ¥æ”¶**: æ¥æ”¶ç®¡ç†å‘˜å‘é€çš„é€šçŸ¥

æ ¸å¿ƒå½•åˆ¶é€»è¾‘ï¼š
```javascript
// å½•åˆ¶çŠ¶æ€ç®¡ç†
let RecordList = {
    screen: {
        state: 'end',           // å½•åˆ¶çŠ¶æ€: end/start/pause
        device: '',             // è®¾å¤‡ID
        stream: null,           // åª’ä½“æµ
        recorder: null,         // å½•åˆ¶å™¨
        peer: null             // WebRTCè¿æ¥
    },
    camera: { /* åŒä¸Š */ }
};

// å¼€å§‹å½•åˆ¶
const startRecord = async (type) => {
    const constraints = type === 'screen' ?
        { video: { width: VideoWidth, height: VideoHeight, frameRate: VideoRate } } :
        { video: true, audio: false };

    const stream = type === 'screen' ?
        await navigator.mediaDevices.getDisplayMedia(constraints) :
        await navigator.mediaDevices.getUserMedia(constraints);

    // åˆ›å»ºå½•åˆ¶å™¨å¹¶å¼€å§‹å½•åˆ¶
    const recorder = new MediaRecorder(stream, { mimeType: VideoConfig.mimeType });
    // ... å½•åˆ¶é€»è¾‘
};
```

### 2. ç›‘æ§é¡µé¢ (views/monitor.html + js/controller.js)

ç®¡ç†å‘˜ç«¯ç›‘æ§ç•Œé¢ï¼š
- **å­¦ç”Ÿåˆ—è¡¨**: æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿçš„å®æ—¶çŠ¶æ€
- **å½•åˆ¶æ§åˆ¶**: å…¨ä½“å¼€å§‹/åœæ­¢å½•åˆ¶
- **å®æ—¶ç›‘æ§**: æŸ¥çœ‹å­¦ç”Ÿå±å¹•/æ‘„åƒå¤´
- **é€šçŸ¥å‘é€**: å‘é€é€šçŸ¥ç»™å­¦ç”Ÿ
- **æƒé™ç®¡ç†**: ç¦ç”¨å­¦ç”Ÿç™»å½•æƒé™
- **è€ƒè¯•ç®¡ç†**: è€ƒè¯•ç›¸å…³çš„å­¦ç”Ÿç®¡ç†æ“ä½œ

çŠ¶æ€æ˜¾ç¤ºï¼š
```javascript
// å®æ—¶æ›´æ–°å­¦ç”ŸçŠ¶æ€
Socket.on('state', (AllUsers) => {
    Object.values(AllUsers).forEach(user => {
        if (user.stu_userlevel !== '1') {
            // æ›´æ–°åœ¨çº¿çŠ¶æ€
            document.getElementById(`${user.stu_no}-online`).innerText = user.online;

            // æ›´æ–°å½•åˆ¶çŠ¶æ€
            updateRecordStatus(user, 'screen');
            updateRecordStatus(user, 'camera');

            // æ›´æ–°ä¸­æ–­æ¬¡æ•°å’Œç´¯è®¡æ—¶é•¿
            document.getElementById(`${user.stu_no}-interruptions`).innerText = user.interruptions;
            document.getElementById(`${user.stu_no}-duration`).innerText =
                formatDuration(user.accumulatedDuration);
        }
    });
});
```

## æ•°æ®åº“è®¾è®¡

### å­¦ç”Ÿè¡¨ (student)
```sql
CREATE TABLE student (
    stu_grade CHAR(4) NOT NULL,        -- å¹´çº§
    stu_no CHAR(8) NOT NULL,           -- å­¦å·
    stu_name CHAR(16) NOT NULL,        -- å§“å
    stu_password CHAR(32) NOT NULL,    -- å¯†ç (MD5)
    stu_sex CHAR(2) NOT NULL DEFAULT 'ç”·',
    stu_class_fname CHAR(32) NOT NULL, -- ç­çº§å…¨å
    stu_class_sname CHAR(16) NOT NULL, -- ç­çº§ç®€å
    stu_term CHAR(11) NOT NULL,        -- å­¦æœŸ
    stu_cno CHAR(8) NOT NULL,          -- è¯¾ç¨‹å·
    stu_wtype CHAR(1) NOT NULL DEFAULT '0',
    stu_userlevel CHAR(1) NOT NULL DEFAULT '0', -- ç”¨æˆ·çº§åˆ«
    stu_enable CHAR(1) NOT NULL DEFAULT '1',    -- æ˜¯å¦å¯ç”¨
    PRIMARY KEY(stu_grade, stu_no)
);
```

### æ—¥å¿—è¡¨ (logs)
```sql
CREATE TABLE logs (
    log_id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    log_cno CHAR(16),                  -- è¯¾ç¨‹å·
    log_sno CHAR(8) NOT NULL,          -- å­¦å·
    log_ipaddr CHAR(25) NOT NULL,      -- IPåœ°å€
    log_date DATETIME DEFAULT NOW() NOT NULL, -- æ—¶é—´
    log_content VARCHAR(1000)          -- æ—¥å¿—å†…å®¹
);
```

### å­˜å‚¨è¿‡ç¨‹
```sql
-- æ·»åŠ æ—¥å¿—çš„å­˜å‚¨è¿‡ç¨‹
CREATE PROCEDURE addLog(
    IN i_cno CHAR(16),
    IN i_sno CHAR(8),
    IN i_ipaddr CHAR(25),
    IN i_content VARCHAR(1000)
)
BEGIN
    INSERT INTO logs (log_cno, log_sno, log_ipaddr, log_content)
    VALUES (i_cno, i_sno, i_ipaddr, i_content);
END
```

## é…ç½®æ–‡ä»¶è¯¦è§£

### ä¸»é…ç½®æ–‡ä»¶ (config.js)

```javascript
// æœåŠ¡å™¨é…ç½®
const serverConfig = {
    sessionSecret: 'your-session-secret',  // Sessionå¯†é’¥
    savePath: './video',                   // å½•åˆ¶æ–‡ä»¶ä¿å­˜è·¯å¾„
    certPath: './ssl/cert.crt',           // SSLè¯ä¹¦è·¯å¾„
    keyPath: './ssl/private.key'          // SSLç§é’¥è·¯å¾„
};

// æ•°æ®åº“é…ç½®
const databaseConfig = {
    host: '127.0.0.1',                    // æ•°æ®åº“ä¸»æœº
    port: 3306,                           // æ•°æ®åº“ç«¯å£
    database: 'user',                     // æ•°æ®åº“å
    user: 'root',                         // æ•°æ®åº“ç”¨æˆ·
    password: 'password',                 // æ•°æ®åº“å¯†ç 
    stulist: 'monitor',                   // å­¦ç”Ÿåˆ—è¡¨æ¨¡å¼: monitor/exam
    type: 'all'                           // ç±»å‹: valid/all
};

// è§†é¢‘é…ç½®
const videoConfig = {
    width: 1920,                          // å½•åˆ¶å®½åº¦
    height: 1080,                         // å½•åˆ¶é«˜åº¦
    frameRate: 15,                        // å¸§ç‡
    sliceTime: 3000,                      // åˆ‡ç‰‡æ—¶é—´(æ¯«ç§’)
    allowRecord: {                        // å…è®¸å½•åˆ¶çš„ç±»å‹
        screen: true,                     // å±å¹•å½•åˆ¶
        camera: true                      // æ‘„åƒå¤´å½•åˆ¶
    },
    mimeType: 'video/webm;codecs=h264'   // å½•åˆ¶æ ¼å¼
};

// ç½‘ç»œé…ç½®
const networkConfig = {
    socketPort: 7080,                     // Socket.IOç«¯å£
    turnServerPort: 7100,                 // TURNæœåŠ¡å™¨ç«¯å£
    turnServerUsername: 'username',       // TURNç”¨æˆ·å
    turnServerCredential: 'password'      // TURNå¯†ç 
};
```

### TURNæœåŠ¡å™¨é…ç½® (turnserver.conf)

```conf
realm=DOMAIN                              # åŸŸå
listening-port=7100                       # ç›‘å¬ç«¯å£
listening-ip=1.2.3.4                    # ç›‘å¬IP
external-ip=1.2.3.4                     # å¤–éƒ¨IP
log-file=/var/log/turnserver.log         # æ—¥å¿—æ–‡ä»¶
user=username:password                    # ç”¨æˆ·è®¤è¯
cli-password=password                     # ç®¡ç†å¯†ç 
no-tls                                   # ç¦ç”¨TLS
no-dtls                                  # ç¦ç”¨DTLS
fingerprint                              # å¯ç”¨æŒ‡çº¹
lt-cred-mech                             # é•¿æœŸå‡­è¯æœºåˆ¶
no-stdout-log                            # ç¦ç”¨æ ‡å‡†è¾“å‡ºæ—¥å¿—
```

## éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 20.04+)
- **Node.js**: 16.x æˆ–æ›´é«˜ç‰ˆæœ¬
- **æ•°æ®åº“**: MySQL 8.0+ æˆ– MariaDB 10.5+
- **Redis**: 6.0+
- **SSLè¯ä¹¦**: ç”¨äºHTTPSè®¿é—®
- **åŸŸå**: ç”¨äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. ç³»ç»Ÿä¾èµ–å®‰è£…

#### Ubuntu/Debian
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Node.js
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£… MariaDB
sudo apt install mariadb-server mariadb-client -y

# å®‰è£… Redis
sudo apt install redis-server -y

# å®‰è£… Coturn (TURNæœåŠ¡å™¨)
sudo apt install coturn -y
```

#### CentOS/RHEL
```bash
# å®‰è£… Node.js
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
sudo yum install nodejs -y

# å®‰è£… MariaDB
sudo yum install mariadb-server mariadb -y

# å®‰è£… Redis
sudo yum install redis -y

# å®‰è£… Coturn
sudo yum install coturn -y
```

### 2. æ•°æ®åº“é…ç½®

#### ä½¿ç”¨ Docker å®‰è£… MariaDB (æ¨è)
```bash
# åˆ›å»ºå¹¶è¿è¡Œ MariaDB å®¹å™¨
docker run --name mariadb \
  -d \
  -p 3306:3306 \
  -v /var/lib/mysql:/var/lib/mysql \
  -e MARIADB_ROOT_PASSWORD=your_password \
  mariadb

# å¯¼å…¥æ•°æ®åº“ç»“æ„
mysql -u root -p < user.sql
```

#### ç›´æ¥å®‰è£…é…ç½®
```bash
# å¯åŠ¨ MariaDB æœåŠ¡
sudo systemctl start mariadb
sudo systemctl enable mariadb

# å®‰å…¨é…ç½®
sudo mysql_secure_installation

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
mysql -u root -p
```

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE webrtc CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºç”¨æˆ·
CREATE USER 'webrtc_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON webrtc.* TO 'webrtc_user'@'localhost';
FLUSH PRIVILEGES;

-- å¯¼å…¥è¡¨ç»“æ„
USE webrtc;
SOURCE /path/to/user.sql;
```

### 3. Redis é…ç½®

```bash
# å¯åŠ¨ Redis æœåŠ¡
sudo systemctl start redis
sudo systemctl enable redis

# é…ç½® Redis (å¯é€‰)
sudo nano /etc/redis/redis.conf
# è®¾ç½®å¯†ç : requirepass your_redis_password
# é‡å¯æœåŠ¡: sudo systemctl restart redis
```

### 4. TURN æœåŠ¡å™¨é…ç½®

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp turnserver_example.conf turnserver.conf

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano turnserver.conf
```

é…ç½®ç¤ºä¾‹ï¼š
```conf
realm=your-domain.com
listening-port=7100
listening-ip=0.0.0.0
external-ip=YOUR_PUBLIC_IP
log-file=/var/log/turnserver.log
user=webrtc_user:webrtc_password
cli-password=admin_password
no-tls
no-dtls
fingerprint
lt-cred-mech
no-stdout-log
```

#### ä½¿ç”¨ Docker è¿è¡Œ Coturn
```bash
# è¿è¡Œ Coturn å®¹å™¨
docker run --name coturn \
  -d \
  --network=host \
  -v $(pwd)/turnserver.conf:/etc/coturn/turnserver.conf \
  coturn/coturn
```

#### ç›´æ¥è¿è¡Œ Coturn
```bash
# å¯åŠ¨ Coturn æœåŠ¡
sudo turnserver -o -c turnserver.conf

# æˆ–è€…ä½œä¸ºç³»ç»ŸæœåŠ¡
sudo systemctl start coturn
sudo systemctl enable coturn
```

### 5. SSL è¯ä¹¦é…ç½®

#### ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ (å¼€å‘ç¯å¢ƒ)
```bash
mkdir -p ssl && cd ssl
openssl req -days 3650 -x509 -newkey rsa:2048 -keyout private.key -out cert.crt -nodes
```

#### ä½¿ç”¨ Let's Encrypt (ç”Ÿäº§ç¯å¢ƒ)
```bash
# å®‰è£… Certbot
sudo apt install certbot -y

# è·å–è¯ä¹¦
sudo certbot certonly --standalone -d your-domain.com

# å¤åˆ¶è¯ä¹¦åˆ°é¡¹ç›®ç›®å½•
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem ssl/cert.crt
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem ssl/private.key
sudo chown $USER:$USER ssl/*
```

### 6. é¡¹ç›®é…ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/vozeo/WebRecord.git
cd WebRecord

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp config_example.js config.js

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano config.js
```

é…ç½®è¦ç‚¹ï¼š
- ä¿®æ”¹æ•°æ®åº“è¿æ¥ä¿¡æ¯
- è®¾ç½®æ­£ç¡®çš„ TURN æœåŠ¡å™¨ä¿¡æ¯
- é…ç½®æ–‡ä»¶ä¿å­˜è·¯å¾„
- è®¾ç½® SSL è¯ä¹¦è·¯å¾„

### 7. å®‰è£…ä¾èµ–å’Œå¯åŠ¨

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
pnpm install

# åˆ›å»ºå½•åˆ¶æ–‡ä»¶ç›®å½•
mkdir -p video

# å¯åŠ¨åº”ç”¨ (å¼€å‘æ¨¡å¼)
node app.js

# ä½¿ç”¨ PM2 è¿›ç¨‹ç®¡ç† (ç”Ÿäº§æ¨¡å¼)
sudo npm install -g pm2
pm2 start app.js --name webrtc-monitor
pm2 save
pm2 startup
```

### 8. é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 7080/tcp  # WebRTC åº”ç”¨ç«¯å£
sudo ufw allow 7100/tcp  # TURN æœåŠ¡å™¨ç«¯å£
sudo ufw allow 7100/udp  # TURN æœåŠ¡å™¨ UDP
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=7080/tcp
sudo firewall-cmd --permanent --add-port=7100/tcp
sudo firewall-cmd --permanent --add-port=7100/udp
sudo firewall-cmd --reload
```

### 9. Nginx åå‘ä»£ç† (å¯é€‰)

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/ssl/cert.crt;
    ssl_certificate_key /path/to/ssl/private.key;

    location / {
        proxy_pass https://localhost:7080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Socket.IO æ”¯æŒ
    location /socket.io/ {
        proxy_pass https://localhost:7080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## å¼€å‘æŒ‡å—

### å¼€å‘ç¯å¢ƒæ­å»º

1. **å…‹éš†é¡¹ç›®**
```bash
git clone https://github.com/vozeo/WebRecord.git
cd WebRecord
```

2. **å®‰è£…ä¾èµ–**
```bash
# ä½¿ç”¨ pnpm (æ¨è)
pnpm install

# æˆ–ä½¿ç”¨ npm
npm install
```

3. **é…ç½®å¼€å‘ç¯å¢ƒ**
```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp config_example.js config.js
cp turnserver_example.conf turnserver.conf

# ç”Ÿæˆå¼€å‘ç”¨SSLè¯ä¹¦
mkdir ssl
openssl req -x509 -newkey rsa:2048 -keyout ssl/private.key -out ssl/cert.crt -days 365 -nodes
```

4. **å¯åŠ¨å¼€å‘æœåŠ¡**
```bash
# å¯åŠ¨æ•°æ®åº“ (Docker)
docker run --name dev-mariadb -d -p 3306:3306 -e MARIADB_ROOT_PASSWORD=dev123 mariadb

# å¯åŠ¨ Redis (Docker)
docker run --name dev-redis -d -p 6379:6379 redis

# å¯åŠ¨ TURN æœåŠ¡å™¨ (Docker)
docker run --name dev-coturn -d --network=host -v $(pwd)/turnserver.conf:/etc/coturn/turnserver.conf coturn/coturn

# å¯åŠ¨åº”ç”¨
node app.js
```

### ä»£ç ç»“æ„è§„èŒƒ

#### 1. æ–‡ä»¶å‘½åè§„èŒƒ
- è·¯ç”±æ–‡ä»¶ï¼š`routes/åŠŸèƒ½å.js`
- æœåŠ¡æ–‡ä»¶ï¼š`services/æœåŠ¡å.js`
- ä¸­é—´ä»¶ï¼š`middleware/åŠŸèƒ½å.js`
- å‰ç«¯è„šæœ¬ï¼š`js/åŠŸèƒ½å.js`
- é¡µé¢æ¨¡æ¿ï¼š`views/é¡µé¢å.html`

#### 2. ä»£ç é£æ ¼
- ä½¿ç”¨ ES6+ è¯­æ³•
- å¼‚æ­¥æ“ä½œä½¿ç”¨ async/await
- é”™è¯¯å¤„ç†ä½¿ç”¨ try-catch
- å‡½æ•°å’Œå˜é‡ä½¿ç”¨é©¼å³°å‘½å
- å¸¸é‡ä½¿ç”¨å¤§å†™ä¸‹åˆ’çº¿å‘½å

#### 3. æ³¨é‡Šè§„èŒƒ
```javascript
/**
 * å‡½æ•°æè¿°
 * @param {ç±»å‹} å‚æ•°å - å‚æ•°æè¿°
 * @returns {ç±»å‹} è¿”å›å€¼æè¿°
 */
const functionName = async (param) => {
    // å®ç°é€»è¾‘
};
```

### æ·»åŠ æ–°åŠŸèƒ½

#### 1. æ·»åŠ æ–°çš„APIæ¥å£

åœ¨ `routes/api.js` ä¸­æ·»åŠ ï¼š
```javascript
// æ–°åŠŸèƒ½API
router.post('/new-feature', auth, async (req, res) => {
    try {
        const userIP = req.ip;
        const user = await getUserById(req.session.user.stu_no);

        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        const result = await processNewFeature(req.body);

        // è®°å½•æ—¥å¿—
        await addLog(user, userIP, 'new_feature', 'æ‰§è¡Œæ–°åŠŸèƒ½');

        res.json({ code: 0, message: 'Success', data: result });
    } catch (error) {
        console.error('æ–°åŠŸèƒ½é”™è¯¯:', error);
        res.status(500).json({ code: -1, message: error.message });
    }
});
```

#### 2. æ·»åŠ æ–°çš„Socketäº‹ä»¶

åœ¨ `services/socketHandler.js` ä¸­æ·»åŠ ï¼š
```javascript
// æ–°çš„Socketäº‹ä»¶å¤„ç†
socket.on('new-event', async (data) => {
    try {
        // å¤„ç†é€»è¾‘
        const result = await handleNewEvent(data);

        // å¹¿æ’­ç»“æœ
        io.emit('new-event-response', result);
    } catch (error) {
        console.error('Socketäº‹ä»¶é”™è¯¯:', error);
    }
});
```

#### 3. æ·»åŠ æ–°é¡µé¢

1. åˆ›å»ºé¡µé¢æ¨¡æ¿ `views/new-page.html`
2. æ·»åŠ è·¯ç”± `routes/pages.js`
3. åˆ›å»ºå‰ç«¯è„šæœ¬ `js/new-page.js`

### è°ƒè¯•æŠ€å·§

#### 1. åç«¯è°ƒè¯•
```javascript
// ä½¿ç”¨ console.log è¿›è¡Œè°ƒè¯•
console.log('è°ƒè¯•ä¿¡æ¯:', variable);

// ä½¿ç”¨ Node.js è°ƒè¯•å™¨
node --inspect app.js

// ä½¿ç”¨ PM2 æŸ¥çœ‹æ—¥å¿—
pm2 logs webrtc-monitor
```

#### 2. å‰ç«¯è°ƒè¯•
```javascript
// æµè§ˆå™¨æ§åˆ¶å°è°ƒè¯•
console.log('å‰ç«¯è°ƒè¯•:', data);

// Socket.IO è°ƒè¯•
Socket.on('connect', () => {
    console.log('Socketè¿æ¥æˆåŠŸ');
});

Socket.on('disconnect', () => {
    console.log('Socketè¿æ¥æ–­å¼€');
});
```

#### 3. ç½‘ç»œè°ƒè¯•
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :7080

# æ£€æŸ¥ TURN æœåŠ¡å™¨
turnutils_uclient -T -u username -w password your-server-ip

# æ£€æŸ¥ SSL è¯ä¹¦
openssl x509 -in ssl/cert.crt -text -noout
```

## API æ–‡æ¡£

### è®¤è¯ç›¸å…³

#### POST /login
ç”¨æˆ·ç™»å½•

**è¯·æ±‚å‚æ•°:**
```json
{
    "username": "å­¦å·",
    "password": "å¯†ç "
}
```

**å“åº”:**
```json
{
    "code": 0,
    "message": "ç™»å½•æˆåŠŸ"
}
```

#### POST /logout
ç”¨æˆ·ç™»å‡º

**å“åº”:**
```json
{
    "code": 0,
    "message": "ç™»å‡ºæˆåŠŸ"
}
```

#### POST /change-password
ä¿®æ”¹å¯†ç 

**è¯·æ±‚å‚æ•°:**
```json
{
    "oldPassword": "æ—§å¯†ç ",
    "newPassword": "æ–°å¯†ç "
}
```

### ç³»ç»Ÿä¿¡æ¯

#### GET /information
è·å–ç³»ç»Ÿé…ç½®ä¿¡æ¯

**å“åº”:**
```json
{
    "videoConfig": {
        "width": 1920,
        "height": 1080,
        "frameRate": 15,
        "sliceTime": 3000,
        "allowRecord": {
            "screen": true,
            "camera": true
        },
        "mimeType": "video/webm;codecs=h264"
    },
    "networkConfig": {
        "socketPort": 7080,
        "turnServerPort": 7100,
        "turnServerUsername": "username",
        "turnServerCredential": "password"
    },
    "sessionUser": {
        "stu_no": "å­¦å·",
        "stu_name": "å§“å",
        "stu_userlevel": "ç”¨æˆ·çº§åˆ«"
    }
}
```

### ç›‘æ§ç®¡ç† (éœ€è¦ç®¡ç†å‘˜æƒé™)

#### GET /stulist
è·å–å­¦ç”Ÿåˆ—è¡¨

**å“åº”:**
```json
{
    "stulist": [
        {
            "sno": "å­¦å·",
            "name": "å§“å",
            "class": "ç­çº§"
        }
    ]
}
```

#### POST /disable
ç¦ç”¨ç”¨æˆ·ç™»å½•

**è¯·æ±‚å‚æ•°:**
```json
{
    "id": "å­¦å·"
}
```

#### POST /emit
å‘é€é€šçŸ¥æˆ–å½•åˆ¶æŒ‡ä»¤

**è¯·æ±‚å‚æ•°:**
```json
{
    "type": "notice|record",
    "target": "all|å­¦å·",
    "data": "é€šçŸ¥å†…å®¹æˆ–å½•åˆ¶æŒ‡ä»¤"
}
```

#### GET /file
è·å–å½•åˆ¶æ–‡ä»¶åˆ—è¡¨

**å“åº”:**
```json
{
    "å­¦å·": ["æ–‡ä»¶1.webm", "æ–‡ä»¶2.webm"]
}
```

#### GET /record_file_list
è·å–å½•åˆ¶æ–‡ä»¶ç›‘æ§ä¿¡æ¯

**å“åº”:**
```json
[
    {
        "studentId": "å­¦å·",
        "modificationTimeStr": "2023-12-01 10:30:00",
        "timeDiff": 120,
        "isBelowThreshold": false,
        "fileSize": "15.2 MB"
    }
]
```

### æ–‡ä»¶ä¸‹è½½

#### GET /download/:studentId/:filename
ä¸‹è½½å½•åˆ¶æ–‡ä»¶

**å‚æ•°:**
- `studentId`: å­¦å·
- `filename`: æ–‡ä»¶å

**å“åº”:** æ–‡ä»¶æµ

## Socket.IO äº‹ä»¶æ–‡æ¡£

### å®¢æˆ·ç«¯å‘é€äº‹ä»¶

#### message
å½•åˆ¶çŠ¶æ€å˜åŒ–

**å‚æ•°:**
- `srcId`: ç”¨æˆ·ID
- `type`: æ¶ˆæ¯ç±»å‹ ('online', 'screen', 'camera')
- `args`: å‚æ•° (true/false æˆ– [device, time])
- `callback`: å›è°ƒå‡½æ•°

```javascript
// ä¸Šçº¿é€šçŸ¥
Socket.emit('message', userId, 'online', true, callback);

// å¼€å§‹å½•åˆ¶
Socket.emit('message', userId, 'screen', [deviceId, timestamp], callback);

// åœæ­¢å½•åˆ¶
Socket.emit('message', userId, 'screen', false, callback);
```

#### watch
ç›‘æ§è¯·æ±‚

**å‚æ•°:**
- `srcId`: ç›‘æ§è€…ID
- `dstId`: è¢«ç›‘æ§è€…ID

```javascript
Socket.emit('watch', monitorId, studentId);
```

#### screen
å±å¹•æ•°é‡å˜åŒ–

**å‚æ•°:**
- `srcId`: ç”¨æˆ·ID
- `number`: å±å¹•æ•°é‡

```javascript
Socket.emit('screen', userId, screenCount);
```

#### file
æ–‡ä»¶ä¸Šä¼ 

**å‚æ•°:**
- `srcId`: ç”¨æˆ·ID
- `type`: å½•åˆ¶ç±»å‹ ('screen', 'camera')
- `device`: è®¾å¤‡ID
- `time`: æ—¶é—´æˆ³
- `data`: æ–‡ä»¶æ•°æ®

```javascript
Socket.emit('file', userId, 'screen', deviceId, timestamp, fileData);
```

### æœåŠ¡ç«¯å‘é€äº‹ä»¶

#### state
ç”¨æˆ·çŠ¶æ€æ›´æ–°

**æ•°æ®:** æ‰€æœ‰ç”¨æˆ·çŠ¶æ€å¯¹è±¡

```javascript
Socket.on('state', (AllUsers) => {
    // å¤„ç†çŠ¶æ€æ›´æ–°
});
```

#### notice
é€šçŸ¥æ¶ˆæ¯

**å‚æ•°:**
- `target`: ç›®æ ‡ ('all' æˆ– ç”¨æˆ·ID)
- `data`: é€šçŸ¥å†…å®¹

```javascript
Socket.on('notice', (target, message) => {
    if (target === 'all' || target === currentUserId) {
        showNotification(message);
    }
});
```

#### record
å½•åˆ¶æŒ‡ä»¤

**å‚æ•°:**
- `command`: å½•åˆ¶å‘½ä»¤ (true=å¼€å§‹, false=åœæ­¢)

```javascript
Socket.on('record', (command) => {
    if (command) {
        startRecording();
    } else {
        stopRecording();
    }
});
```

#### disable
ç¦ç”¨ç”¨æˆ·

**å‚æ•°:**
- `userId`: è¢«ç¦ç”¨çš„ç”¨æˆ·ID

```javascript
Socket.on('disable', (userId) => {
    if (userId === currentUserId) {
        window.location.replace('/logout');
    }
});
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨
**ç—‡çŠ¶:** é¡µé¢æ˜¾ç¤º"æœªè¿æ¥"çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ:**
```bash
# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
ps aux | grep node

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tlnp | grep :7080

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw status
sudo firewall-cmd --list-ports

# æ£€æŸ¥SSLè¯ä¹¦
openssl x509 -in ssl/cert.crt -text -noout
```

#### 2. å½•åˆ¶åŠŸèƒ½ä¸å·¥ä½œ
**ç—‡çŠ¶:** ç‚¹å‡»å½•åˆ¶æŒ‰é’®æ— ååº”

**è§£å†³æ–¹æ¡ˆ:**
```javascript
// æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    console.error('æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å½•åˆ¶');
}

// æ£€æŸ¥æƒé™
navigator.permissions.query({name: 'camera'}).then(result => {
    console.log('æ‘„åƒå¤´æƒé™:', result.state);
});
```

#### 3. TURNæœåŠ¡å™¨è¿æ¥å¤±è´¥
**ç—‡çŠ¶:** WebRTCè¿æ¥å»ºç«‹å¤±è´¥

**è§£å†³æ–¹æ¡ˆ:**
```bash
# æµ‹è¯•TURNæœåŠ¡å™¨
turnutils_uclient -T -u username -w password server-ip

# æ£€æŸ¥TURNæœåŠ¡å™¨æ—¥å¿—
tail -f /var/log/turnserver.log

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat turnserver.conf
```

#### 4. æ•°æ®åº“è¿æ¥é”™è¯¯
**ç—‡çŠ¶:** ç™»å½•å¤±è´¥æˆ–æ•°æ®æ— æ³•ä¿å­˜

**è§£å†³æ–¹æ¡ˆ:**
```bash
# æ£€æŸ¥æ•°æ®åº“æœåŠ¡
sudo systemctl status mariadb

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u username -p -h localhost database_name

# æ£€æŸ¥æ•°æ®åº“é…ç½®
cat config.js | grep -A 10 databaseConfig
```

#### 5. æ–‡ä»¶ä¸Šä¼ å¤±è´¥
**ç—‡çŠ¶:** å½•åˆ¶æ–‡ä»¶æ— æ³•ä¿å­˜

**è§£å†³æ–¹æ¡ˆ:**
```bash
# æ£€æŸ¥å­˜å‚¨ç›®å½•æƒé™
ls -la video/
chmod 755 video/
chown user:user video/

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
grep maxHttpBufferSize app.js
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. å½•åˆ¶æ€§èƒ½ä¼˜åŒ–
```javascript
// è°ƒæ•´å½•åˆ¶å‚æ•°
const videoConfig = {
    width: 1280,        // é™ä½åˆ†è¾¨ç‡
    height: 720,
    frameRate: 10,      // é™ä½å¸§ç‡
    sliceTime: 5000,    // å¢åŠ åˆ‡ç‰‡æ—¶é—´
    mimeType: 'video/webm;codecs=vp8'  // ä½¿ç”¨VP8ç¼–ç 
};
```

#### 2. æœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ–
```javascript
// Socket.IOä¼˜åŒ–
const io = new Server(server, {
    pingInterval: 25000,    // å¢åŠ å¿ƒè·³é—´éš”
    pingTimeout: 60000,     // å¢åŠ è¶…æ—¶æ—¶é—´
    maxHttpBufferSize: 5e7, // é™åˆ¶ç¼“å†²åŒºå¤§å°
    transports: ['websocket'] // ä»…ä½¿ç”¨WebSocket
});
```

#### 3. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_student_no ON student(stu_no);
CREATE INDEX idx_log_date ON logs(log_date);
CREATE INDEX idx_log_sno ON logs(log_sno);

-- å®šæœŸæ¸…ç†æ—¥å¿—
DELETE FROM logs WHERE log_date < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### ç›‘æ§å’Œæ—¥å¿—

#### 1. åº”ç”¨ç›‘æ§
```bash
# ä½¿ç”¨PM2ç›‘æ§
pm2 monit

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs webrtc-monitor

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
iotop
```

#### 2. æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep -i error /var/log/webrtc/*.log

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f access.log | grep -E "(POST|GET)"

# åˆ†æè¿æ¥æ•°
netstat -an | grep :7080 | wc -l
```

#### 3. æ€§èƒ½ç›‘æ§
```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
free -h

# ç›‘æ§ç£ç›˜IO
iostat -x 1

# ç›‘æ§ç½‘ç»œæµé‡
iftop
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. ç½‘ç»œå®‰å…¨
- ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
- é…ç½®é˜²ç«å¢™è§„åˆ™
- å®šæœŸæ›´æ–°SSLè¯ä¹¦
- é™åˆ¶ç®¡ç†å‘˜IPè®¿é—®

### 2. æ•°æ®å®‰å…¨
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- åŠ å¯†å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- è®¾ç½®å¼ºå¯†ç ç­–ç•¥
- å®šæœŸæ¸…ç†è¿‡æœŸæ–‡ä»¶

### 3. åº”ç”¨å®‰å…¨
- è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤
- CSRFä»¤ç‰ŒéªŒè¯

## ç»´æŠ¤æŒ‡å—

### 1. å®šæœŸç»´æŠ¤ä»»åŠ¡
```bash
# æ¯æ—¥ä»»åŠ¡
- æ£€æŸ¥æœåŠ¡çŠ¶æ€
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- ç›‘æ§ç£ç›˜ç©ºé—´

# æ¯å‘¨ä»»åŠ¡
- æ¸…ç†è¿‡æœŸå½•åˆ¶æ–‡ä»¶
- å¤‡ä»½æ•°æ®åº“
- æ›´æ–°ç³»ç»Ÿè¡¥ä¸

# æ¯æœˆä»»åŠ¡
- åˆ†ææ€§èƒ½æ•°æ®
- ä¼˜åŒ–æ•°æ®åº“
- æ£€æŸ¥å®‰å…¨è®¾ç½®
```

### 2. å¤‡ä»½ç­–ç•¥
```bash
# æ•°æ®åº“å¤‡ä»½
mysqldump -u root -p webrtc > backup_$(date +%Y%m%d).sql

# å½•åˆ¶æ–‡ä»¶å¤‡ä»½
tar -czf video_backup_$(date +%Y%m%d).tar.gz video/

# é…ç½®æ–‡ä»¶å¤‡ä»½
cp config.js config_backup_$(date +%Y%m%d).js
```

### 3. æ›´æ–°æµç¨‹
```bash
# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp -r WebRecord WebRecord_backup

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. æ›´æ–°ä¾èµ–
pnpm install

# 4. é‡å¯æœåŠ¡
pm2 restart webrtc-monitor

# 5. éªŒè¯åŠŸèƒ½
curl -k https://localhost:7080/
```

---

## è”ç³»ä¿¡æ¯

- **é¡¹ç›®åœ°å€**: https://github.com/vozeo/WebRecord
- **åŸå§‹é¡¹ç›®**: https://github.com/vozeo/RemoteRecord
- **é—®é¢˜åé¦ˆ**: è¯·åœ¨GitHub Issuesä¸­æäº¤
- **æŠ€æœ¯æ”¯æŒ**: è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–ç¤¾åŒºè®¨è®º

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´: 2024å¹´8æœˆ*
