# WebRecord 项目开发文档

![](https://img.shields.io/badge/Version-3.0-green?style=flat-square)

## 项目概述

WebRecord 是一个基于 WebRTC 技术的浏览器端录制系统，主要用于在线考试监控。系统支持屏幕录制、摄像头录制、实时监控和服务器端实时保存等功能。项目采用 Node.js + Express + Socket.IO + WebRTC 技术栈开发。

### 主要功能
- 🎥 **屏幕录制**: 支持高清屏幕录制，可配置分辨率和帧率
- 📹 **摄像头录制**: 支持摄像头录制功能
- 👀 **实时监控**: 管理员可实时查看学生录制状态
- 💾 **自动保存**: 录制内容自动保存到服务器
- 🔐 **权限管理**: 支持学生和管理员两种角色
- 📊 **状态监控**: 实时显示在线状态、录制状态、中断次数等
- 🔔 **通知系统**: 支持全体或单个用户通知
- ⏰ **考试管理**: 支持考试时间控制和学生管理

## 技术架构

### 后端技术栈
- **Node.js**: 运行时环境
- **Express.js**: Web 框架
- **Socket.IO**: 实时通信
- **MySQL/MariaDB**: 数据库
- **Redis**: Session 存储
- **HTTPS**: 安全传输
- **PeerJS**: WebRTC 连接管理
- **Coturn**: TURN/STUN 服务器

### 前端技术栈
- **HTML5**: 页面结构
- **Bootstrap 5**: UI 框架
- **JavaScript ES6+**: 业务逻辑
- **WebRTC API**: 媒体录制
- **Socket.IO Client**: 实时通信
- **Art-template**: 模板引擎

### 系统架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   学生端浏览器   │    │   管理员浏览器   │    │   TURN服务器    │
│                │    │                │    │   (Coturn)     │
│ - 录制界面      │    │ - 监控界面      │    │                │
│ - WebRTC录制    │    │ - 实时查看      │    │ - NAT穿透      │
│ - Socket连接    │    │ - 学生管理      │    │ - 中继服务      │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────┴───────────┐
                    │     WebRecord服务器      │
                    │                        │
                    │ ┌─────────────────────┐ │
                    │ │    Express应用      │ │
                    │ │ - 路由处理          │ │
                    │ │ - 认证中间件        │ │
                    │ │ - 静态文件服务      │ │
                    │ └─────────────────────┘ │
                    │ ┌─────────────────────┐ │
                    │ │   Socket.IO服务     │ │
                    │ │ - 实时通信          │ │
                    │ │ - 状态同步          │ │
                    │ │ - 文件传输          │ │
                    │ └─────────────────────┘ │
                    │ ┌─────────────────────┐ │
                    │ │    业务服务层       │ │
                    │ │ - 用户管理          │ │
                    │ │ - 录制管理          │ │
                    │ │ - 文件管理          │ │
                    │ └─────────────────────┘ │
                    └─────────────┬───────────┘
                                  │
                    ┌─────────────┴───────────┐
                    │      数据存储层         │
                    │                        │
                    │ ┌─────────┐ ┌─────────┐ │
                    │ │ MySQL   │ │ Redis   │ │
                    │ │ 用户数据 │ │ Session │ │
                    │ │ 日志记录 │ │ 缓存    │ │
                    │ └─────────┘ └─────────┘ │
                    │ ┌─────────────────────┐ │
                    │ │     文件系统        │ │
                    │ │   录制文件存储      │ │
                    │ └─────────────────────┘ │
                    └─────────────────────────┘
```

## 项目结构

```
WebRTC/
├── app.js                    # 应用主入口文件
├── package.json              # 项目依赖配置
├── config.js                 # 系统配置文件
├── config_example.js         # 配置文件模板
├── turnserver.conf           # TURN服务器配置
├── turnserver_example.conf   # TURN配置模板
├── database.sql              # 数据库结构
├── user.sql                  # 用户表结构
├── README.md                 # 项目说明
├── 注意事项.txt              # 部署注意事项
│
├── ssl/                      # SSL证书目录
│   ├── cert.crt             # SSL证书
│   └── private.key          # 私钥
│
├── routes/                   # 路由模块
│   ├── pages.js             # 页面路由
│   ├── api.js               # API路由
│   ├── auth.js              # 认证路由
│   └── files.js             # 文件路由
│
├── services/                 # 业务服务层
│   ├── database.js          # 数据库服务
│   ├── socketHandler.js     # Socket处理服务
│   ├── userManager.js       # 用户管理服务
│   └── utils.js             # 工具函数
│
├── middleware/               # 中间件
│   └── auth.js              # 认证中间件
│
├── views/                    # 前端页面
│   ├── template.html        # 页面模板
│   ├── index.html           # 首页
│   ├── login.html           # 登录页
│   ├── record.html          # 录制页
│   ├── monitor.html         # 监控页
│   ├── video.html           # 视频查看页
│   ├── history.html         # 历史记录页
│   ├── password.html        # 密码修改页
│   └── monitor_file.html    # 文件监控页
│
├── js/                       # 前端JavaScript
│   ├── record.js            # 录制功能脚本
│   ├── controller.js        # 监控控制脚本
│   ├── login.js             # 登录脚本
│   └── change.js            # 密码修改脚本
│
├── images/                   # 静态图片资源
├── assets/                   # 其他静态资源
├── docs/                     # 项目文档
│   └── WebRTC-Protocol-Documentation.md
└── node_modules/             # 依赖包目录
```

## 核心模块详解

### 1. 应用入口 (app.js)

应用的主入口文件，负责：
- 创建 HTTPS 服务器
- 配置 Express 应用
- 设置 Socket.IO 服务
- 初始化 WebRTC 服务
- 配置路由和中间件
- 错误处理

关键功能：
```javascript
// 创建HTTPS服务器
const server = https.createServer({
    key: fs.readFileSync(serverConfig.keyPath),
    cert: fs.readFileSync(serverConfig.certPath)
}, app);

// Socket.IO配置
const io = new Server(server, {
    pingInterval: 10000,
    pingTimeout: 60000,
    maxHttpBufferSize: 1e8  // 100MB文件上传限制
});
```

### 2. 数据库服务 (services/database.js)

提供数据库操作接口：
- 用户管理：获取用户信息、更新用户状态
- 日志记录：记录用户操作日志
- 监控管理：获取监控学生列表
- 考试管理：考试学生管理操作

主要函数：
```javascript
// 添加操作日志
const addLog = async (user, ipaddr, type, content, second = 0)

// 获取所有启用用户
const getAllUsers = async ()

// 根据ID获取用户
const getUserById = async (id)

// 获取监控学生列表
const getMonitorStuList = async (monitorId, status)
```

### 3. Socket处理服务 (services/socketHandler.js)

处理实时通信逻辑：
- 连接管理：处理客户端连接和断开
- 录制控制：处理录制开始、停止、中断
- 监控功能：处理实时监控连接
- 文件传输：处理录制文件上传
- 状态同步：同步用户状态到所有客户端

核心事件处理：
```javascript
// 消息事件 - 处理录制状态变化
socket.on('message', async (srcId, type, args, callback) => {
    // 处理在线状态、录制开始/停止
});

// 监控事件 - 处理实时监控
socket.on('watch', async (srcId, dstId) => {
    // 建立监控连接
});

// 文件事件 - 处理录制文件上传
socket.on('file', async (srcId, type, device, time, data) => {
    // 保存录制文件片段
});
```

### 4. 用户管理服务 (services/userManager.js)

管理用户状态和生命周期：
- 用户初始化：从数据库加载用户并创建存储目录
- 状态管理：维护用户在线状态、录制状态等
- 时间检查：监控考试结束时间
- 用户操作：添加、删除、更新用户状态

用户状态结构：
```javascript
AllUsers[userId] = {
    stu_no: string,              // 学号
    stu_cno: string,             // 课程号
    stu_name: string,            // 姓名
    stu_grade: string,           // 年级
    stu_userlevel: string,       // 用户级别 ('1'=管理员)
    stu_class_sname: string,     // 班级名称
    watchList: {},               // 被监控列表
    recordList: {                // 录制状态列表
        camera: {},              // 摄像头录制
        screen: {}               // 屏幕录制
    },
    online: number,              // 在线连接数
    screenNumber: number,        // 屏幕数量
    interruptions: number,       // 中断次数
    accumulatedDuration: number, // 累计录制时长(毫秒)
    lastStartTime: number        // 最后开始时间
};
```

### 5. 认证中间件 (middleware/auth.js)

提供三种认证级别：
- `auth`: 基础认证，检查用户是否登录
- `opAuth`: 管理员认证，检查是否为管理员用户
- `noAuth`: 未认证检查，用于登录页面

认证流程：
```javascript
// 检查用户登录状态
const auth = async (req, res, next) => {
    const user = await getUser(req);
    // 检查是否需要修改密码（默认密码）
    return user ? (cryptPwd(user.stu_no) === user.stu_password &&
                   req.path !== '/password' && req.path !== '/logout' ?
                   res.redirect('/password') : next()) :
                   res.redirect('/login');
};
```

## 前端架构

### 1. 录制页面 (views/record.html + js/record.js)

学生端主要功能页面：
- **连接状态显示**: 显示与服务器的连接状态
- **录制控制**: 屏幕录制和摄像头录制的开始/停止
- **实时状态**: 显示当前录制状态
- **通知接收**: 接收管理员发送的通知

核心录制逻辑：
```javascript
// 录制状态管理
let RecordList = {
    screen: {
        state: 'end',           // 录制状态: end/start/pause
        device: '',             // 设备ID
        stream: null,           // 媒体流
        recorder: null,         // 录制器
        peer: null             // WebRTC连接
    },
    camera: { /* 同上 */ }
};

// 开始录制
const startRecord = async (type) => {
    const constraints = type === 'screen' ?
        { video: { width: VideoWidth, height: VideoHeight, frameRate: VideoRate } } :
        { video: true, audio: false };

    const stream = type === 'screen' ?
        await navigator.mediaDevices.getDisplayMedia(constraints) :
        await navigator.mediaDevices.getUserMedia(constraints);

    // 创建录制器并开始录制
    const recorder = new MediaRecorder(stream, { mimeType: VideoConfig.mimeType });
    // ... 录制逻辑
};
```

### 2. 监控页面 (views/monitor.html + js/controller.js)

管理员端监控界面：
- **学生列表**: 显示所有学生的实时状态
- **录制控制**: 全体开始/停止录制
- **实时监控**: 查看学生屏幕/摄像头
- **通知发送**: 发送通知给学生
- **权限管理**: 禁用学生登录权限
- **考试管理**: 考试相关的学生管理操作

状态显示：
```javascript
// 实时更新学生状态
Socket.on('state', (AllUsers) => {
    Object.values(AllUsers).forEach(user => {
        if (user.stu_userlevel !== '1') {
            // 更新在线状态
            document.getElementById(`${user.stu_no}-online`).innerText = user.online;

            // 更新录制状态
            updateRecordStatus(user, 'screen');
            updateRecordStatus(user, 'camera');

            // 更新中断次数和累计时长
            document.getElementById(`${user.stu_no}-interruptions`).innerText = user.interruptions;
            document.getElementById(`${user.stu_no}-duration`).innerText =
                formatDuration(user.accumulatedDuration);
        }
    });
});
```

## 数据库设计

### 学生表 (student)
```sql
CREATE TABLE student (
    stu_grade CHAR(4) NOT NULL,        -- 年级
    stu_no CHAR(8) NOT NULL,           -- 学号
    stu_name CHAR(16) NOT NULL,        -- 姓名
    stu_password CHAR(32) NOT NULL,    -- 密码(MD5)
    stu_sex CHAR(2) NOT NULL DEFAULT '男',
    stu_class_fname CHAR(32) NOT NULL, -- 班级全名
    stu_class_sname CHAR(16) NOT NULL, -- 班级简名
    stu_term CHAR(11) NOT NULL,        -- 学期
    stu_cno CHAR(8) NOT NULL,          -- 课程号
    stu_wtype CHAR(1) NOT NULL DEFAULT '0',
    stu_userlevel CHAR(1) NOT NULL DEFAULT '0', -- 用户级别
    stu_enable CHAR(1) NOT NULL DEFAULT '1',    -- 是否启用
    PRIMARY KEY(stu_grade, stu_no)
);
```

### 日志表 (logs)
```sql
CREATE TABLE logs (
    log_id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    log_cno CHAR(16),                  -- 课程号
    log_sno CHAR(8) NOT NULL,          -- 学号
    log_ipaddr CHAR(25) NOT NULL,      -- IP地址
    log_date DATETIME DEFAULT NOW() NOT NULL, -- 时间
    log_content VARCHAR(1000)          -- 日志内容
);
```

### 存储过程
```sql
-- 添加日志的存储过程
CREATE PROCEDURE addLog(
    IN i_cno CHAR(16),
    IN i_sno CHAR(8),
    IN i_ipaddr CHAR(25),
    IN i_content VARCHAR(1000)
)
BEGIN
    INSERT INTO logs (log_cno, log_sno, log_ipaddr, log_content)
    VALUES (i_cno, i_sno, i_ipaddr, i_content);
END
```

## 配置文件详解

### 主配置文件 (config.js)

```javascript
// 服务器配置
const serverConfig = {
    sessionSecret: 'your-session-secret',  // Session密钥
    savePath: './video',                   // 录制文件保存路径
    certPath: './ssl/cert.crt',           // SSL证书路径
    keyPath: './ssl/private.key'          // SSL私钥路径
};

// 数据库配置
const databaseConfig = {
    host: '127.0.0.1',                    // 数据库主机
    port: 3306,                           // 数据库端口
    database: 'user',                     // 数据库名
    user: 'root',                         // 数据库用户
    password: 'password',                 // 数据库密码
    stulist: 'monitor',                   // 学生列表模式: monitor/exam
    type: 'all'                           // 类型: valid/all
};

// 视频配置
const videoConfig = {
    width: 1920,                          // 录制宽度
    height: 1080,                         // 录制高度
    frameRate: 15,                        // 帧率
    sliceTime: 3000,                      // 切片时间(毫秒)
    allowRecord: {                        // 允许录制的类型
        screen: true,                     // 屏幕录制
        camera: true                      // 摄像头录制
    },
    mimeType: 'video/webm;codecs=h264'   // 录制格式
};

// 网络配置
const networkConfig = {
    socketPort: 7080,                     // Socket.IO端口
    turnServerPort: 7100,                 // TURN服务器端口
    turnServerUsername: 'username',       // TURN用户名
    turnServerCredential: 'password'      // TURN密码
};
```

### TURN服务器配置 (turnserver.conf)

```conf
realm=DOMAIN                              # 域名
listening-port=7100                       # 监听端口
listening-ip=1.2.3.4                    # 监听IP
external-ip=1.2.3.4                     # 外部IP
log-file=/var/log/turnserver.log         # 日志文件
user=username:password                    # 用户认证
cli-password=password                     # 管理密码
no-tls                                   # 禁用TLS
no-dtls                                  # 禁用DTLS
fingerprint                              # 启用指纹
lt-cred-mech                             # 长期凭证机制
no-stdout-log                            # 禁用标准输出日志
```

## 部署指南

### 环境要求

- **操作系统**: Linux (推荐 Ubuntu 20.04+)
- **Node.js**: 16.x 或更高版本
- **数据库**: MySQL 8.0+ 或 MariaDB 10.5+
- **Redis**: 6.0+
- **SSL证书**: 用于HTTPS访问
- **域名**: 用于生产环境部署

### 1. 系统依赖安装

#### Ubuntu/Debian
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 MariaDB
sudo apt install mariadb-server mariadb-client -y

# 安装 Redis
sudo apt install redis-server -y

# 安装 Coturn (TURN服务器)
sudo apt install coturn -y
```

#### CentOS/RHEL
```bash
# 安装 Node.js
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
sudo yum install nodejs -y

# 安装 MariaDB
sudo yum install mariadb-server mariadb -y

# 安装 Redis
sudo yum install redis -y

# 安装 Coturn
sudo yum install coturn -y
```

### 2. 数据库配置

#### 使用 Docker 安装 MariaDB (推荐)
```bash
# 创建并运行 MariaDB 容器
docker run --name mariadb \
  -d \
  -p 3306:3306 \
  -v /var/lib/mysql:/var/lib/mysql \
  -e MARIADB_ROOT_PASSWORD=your_password \
  mariadb

# 导入数据库结构
mysql -u root -p < user.sql
```

#### 直接安装配置
```bash
# 启动 MariaDB 服务
sudo systemctl start mariadb
sudo systemctl enable mariadb

# 安全配置
sudo mysql_secure_installation

# 创建数据库和用户
mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE webrtc CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'webrtc_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON webrtc.* TO 'webrtc_user'@'localhost';
FLUSH PRIVILEGES;

-- 导入表结构
USE webrtc;
SOURCE /path/to/user.sql;
```

### 3. Redis 配置

```bash
# 启动 Redis 服务
sudo systemctl start redis
sudo systemctl enable redis

# 配置 Redis (可选)
sudo nano /etc/redis/redis.conf
# 设置密码: requirepass your_redis_password
# 重启服务: sudo systemctl restart redis
```

### 4. TURN 服务器配置

```bash
# 复制配置文件
cp turnserver_example.conf turnserver.conf

# 编辑配置文件
nano turnserver.conf
```

配置示例：
```conf
realm=your-domain.com
listening-port=7100
listening-ip=0.0.0.0
external-ip=YOUR_PUBLIC_IP
log-file=/var/log/turnserver.log
user=webrtc_user:webrtc_password
cli-password=admin_password
no-tls
no-dtls
fingerprint
lt-cred-mech
no-stdout-log
```

#### 使用 Docker 运行 Coturn
```bash
# 运行 Coturn 容器
docker run --name coturn \
  -d \
  --network=host \
  -v $(pwd)/turnserver.conf:/etc/coturn/turnserver.conf \
  coturn/coturn
```

#### 直接运行 Coturn
```bash
# 启动 Coturn 服务
sudo turnserver -o -c turnserver.conf

# 或者作为系统服务
sudo systemctl start coturn
sudo systemctl enable coturn
```

### 5. SSL 证书配置

#### 生成自签名证书 (开发环境)
```bash
mkdir -p ssl && cd ssl
openssl req -days 3650 -x509 -newkey rsa:2048 -keyout private.key -out cert.crt -nodes
```

#### 使用 Let's Encrypt (生产环境)
```bash
# 安装 Certbot
sudo apt install certbot -y

# 获取证书
sudo certbot certonly --standalone -d your-domain.com

# 复制证书到项目目录
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem ssl/cert.crt
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem ssl/private.key
sudo chown $USER:$USER ssl/*
```

### 6. 项目配置

```bash
# 克隆项目
git clone https://github.com/vozeo/WebRecord.git
cd WebRecord

# 复制配置文件
cp config_example.js config.js

# 编辑配置文件
nano config.js
```

配置要点：
- 修改数据库连接信息
- 设置正确的 TURN 服务器信息
- 配置文件保存路径
- 设置 SSL 证书路径

### 7. 安装依赖和启动

```bash
# 安装项目依赖
pnpm install

# 创建录制文件目录
mkdir -p video

# 启动应用 (开发模式)
node app.js

# 使用 PM2 进程管理 (生产模式)
sudo npm install -g pm2
pm2 start app.js --name webrtc-monitor
pm2 save
pm2 startup
```

### 8. 防火墙配置

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 7080/tcp  # WebRTC 应用端口
sudo ufw allow 7100/tcp  # TURN 服务器端口
sudo ufw allow 7100/udp  # TURN 服务器 UDP
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=7080/tcp
sudo firewall-cmd --permanent --add-port=7100/tcp
sudo firewall-cmd --permanent --add-port=7100/udp
sudo firewall-cmd --reload
```

### 9. Nginx 反向代理 (可选)

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/ssl/cert.crt;
    ssl_certificate_key /path/to/ssl/private.key;

    location / {
        proxy_pass https://localhost:7080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Socket.IO 支持
    location /socket.io/ {
        proxy_pass https://localhost:7080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 开发指南

### 开发环境搭建

1. **克隆项目**
```bash
git clone https://github.com/vozeo/WebRecord.git
cd WebRecord
```

2. **安装依赖**
```bash
# 使用 pnpm (推荐)
pnpm install

# 或使用 npm
npm install
```

3. **配置开发环境**
```bash
# 复制配置文件
cp config_example.js config.js
cp turnserver_example.conf turnserver.conf

# 生成开发用SSL证书
mkdir ssl
openssl req -x509 -newkey rsa:2048 -keyout ssl/private.key -out ssl/cert.crt -days 365 -nodes
```

4. **启动开发服务**
```bash
# 启动数据库 (Docker)
docker run --name dev-mariadb -d -p 3306:3306 -e MARIADB_ROOT_PASSWORD=dev123 mariadb

# 启动 Redis (Docker)
docker run --name dev-redis -d -p 6379:6379 redis

# 启动 TURN 服务器 (Docker)
docker run --name dev-coturn -d --network=host -v $(pwd)/turnserver.conf:/etc/coturn/turnserver.conf coturn/coturn

# 启动应用
node app.js
```

### 代码结构规范

#### 1. 文件命名规范
- 路由文件：`routes/功能名.js`
- 服务文件：`services/服务名.js`
- 中间件：`middleware/功能名.js`
- 前端脚本：`js/功能名.js`
- 页面模板：`views/页面名.html`

#### 2. 代码风格
- 使用 ES6+ 语法
- 异步操作使用 async/await
- 错误处理使用 try-catch
- 函数和变量使用驼峰命名
- 常量使用大写下划线命名

#### 3. 注释规范
```javascript
/**
 * 函数描述
 * @param {类型} 参数名 - 参数描述
 * @returns {类型} 返回值描述
 */
const functionName = async (param) => {
    // 实现逻辑
};
```

### 添加新功能

#### 1. 添加新的API接口

在 `routes/api.js` 中添加：
```javascript
// 新功能API
router.post('/new-feature', auth, async (req, res) => {
    try {
        const userIP = req.ip;
        const user = await getUserById(req.session.user.stu_no);

        // 业务逻辑处理
        const result = await processNewFeature(req.body);

        // 记录日志
        await addLog(user, userIP, 'new_feature', '执行新功能');

        res.json({ code: 0, message: 'Success', data: result });
    } catch (error) {
        console.error('新功能错误:', error);
        res.status(500).json({ code: -1, message: error.message });
    }
});
```

#### 2. 添加新的Socket事件

在 `services/socketHandler.js` 中添加：
```javascript
// 新的Socket事件处理
socket.on('new-event', async (data) => {
    try {
        // 处理逻辑
        const result = await handleNewEvent(data);

        // 广播结果
        io.emit('new-event-response', result);
    } catch (error) {
        console.error('Socket事件错误:', error);
    }
});
```

#### 3. 添加新页面

1. 创建页面模板 `views/new-page.html`
2. 添加路由 `routes/pages.js`
3. 创建前端脚本 `js/new-page.js`

### 调试技巧

#### 1. 后端调试
```javascript
// 使用 console.log 进行调试
console.log('调试信息:', variable);

// 使用 Node.js 调试器
node --inspect app.js

// 使用 PM2 查看日志
pm2 logs webrtc-monitor
```

#### 2. 前端调试
```javascript
// 浏览器控制台调试
console.log('前端调试:', data);

// Socket.IO 调试
Socket.on('connect', () => {
    console.log('Socket连接成功');
});

Socket.on('disconnect', () => {
    console.log('Socket连接断开');
});
```

#### 3. 网络调试
```bash
# 检查端口占用
netstat -tlnp | grep :7080

# 检查 TURN 服务器
turnutils_uclient -T -u username -w password your-server-ip

# 检查 SSL 证书
openssl x509 -in ssl/cert.crt -text -noout
```

## API 文档

### 认证相关

#### POST /login
用户登录

**请求参数:**
```json
{
    "username": "学号",
    "password": "密码"
}
```

**响应:**
```json
{
    "code": 0,
    "message": "登录成功"
}
```

#### POST /logout
用户登出

**响应:**
```json
{
    "code": 0,
    "message": "登出成功"
}
```

#### POST /change-password
修改密码

**请求参数:**
```json
{
    "oldPassword": "旧密码",
    "newPassword": "新密码"
}
```

### 系统信息

#### GET /information
获取系统配置信息

**响应:**
```json
{
    "videoConfig": {
        "width": 1920,
        "height": 1080,
        "frameRate": 15,
        "sliceTime": 3000,
        "allowRecord": {
            "screen": true,
            "camera": true
        },
        "mimeType": "video/webm;codecs=h264"
    },
    "networkConfig": {
        "socketPort": 7080,
        "turnServerPort": 7100,
        "turnServerUsername": "username",
        "turnServerCredential": "password"
    },
    "sessionUser": {
        "stu_no": "学号",
        "stu_name": "姓名",
        "stu_userlevel": "用户级别"
    }
}
```

### 监控管理 (需要管理员权限)

#### GET /stulist
获取学生列表

**响应:**
```json
{
    "stulist": [
        {
            "sno": "学号",
            "name": "姓名",
            "class": "班级"
        }
    ]
}
```

#### POST /disable
禁用用户登录

**请求参数:**
```json
{
    "id": "学号"
}
```

#### POST /emit
发送通知或录制指令

**请求参数:**
```json
{
    "type": "notice|record",
    "target": "all|学号",
    "data": "通知内容或录制指令"
}
```

#### GET /file
获取录制文件列表

**响应:**
```json
{
    "学号": ["文件1.webm", "文件2.webm"]
}
```

#### GET /record_file_list
获取录制文件监控信息

**响应:**
```json
[
    {
        "studentId": "学号",
        "modificationTimeStr": "2023-12-01 10:30:00",
        "timeDiff": 120,
        "isBelowThreshold": false,
        "fileSize": "15.2 MB"
    }
]
```

### 文件下载

#### GET /download/:studentId/:filename
下载录制文件

**参数:**
- `studentId`: 学号
- `filename`: 文件名

**响应:** 文件流

## Socket.IO 事件文档

### 客户端发送事件

#### message
录制状态变化

**参数:**
- `srcId`: 用户ID
- `type`: 消息类型 ('online', 'screen', 'camera')
- `args`: 参数 (true/false 或 [device, time])
- `callback`: 回调函数

```javascript
// 上线通知
Socket.emit('message', userId, 'online', true, callback);

// 开始录制
Socket.emit('message', userId, 'screen', [deviceId, timestamp], callback);

// 停止录制
Socket.emit('message', userId, 'screen', false, callback);
```

#### watch
监控请求

**参数:**
- `srcId`: 监控者ID
- `dstId`: 被监控者ID

```javascript
Socket.emit('watch', monitorId, studentId);
```

#### screen
屏幕数量变化

**参数:**
- `srcId`: 用户ID
- `number`: 屏幕数量

```javascript
Socket.emit('screen', userId, screenCount);
```

#### file
文件上传

**参数:**
- `srcId`: 用户ID
- `type`: 录制类型 ('screen', 'camera')
- `device`: 设备ID
- `time`: 时间戳
- `data`: 文件数据

```javascript
Socket.emit('file', userId, 'screen', deviceId, timestamp, fileData);
```

### 服务端发送事件

#### state
用户状态更新

**数据:** 所有用户状态对象

```javascript
Socket.on('state', (AllUsers) => {
    // 处理状态更新
});
```

#### notice
通知消息

**参数:**
- `target`: 目标 ('all' 或 用户ID)
- `data`: 通知内容

```javascript
Socket.on('notice', (target, message) => {
    if (target === 'all' || target === currentUserId) {
        showNotification(message);
    }
});
```

#### record
录制指令

**参数:**
- `command`: 录制命令 (true=开始, false=停止)

```javascript
Socket.on('record', (command) => {
    if (command) {
        startRecording();
    } else {
        stopRecording();
    }
});
```

#### disable
禁用用户

**参数:**
- `userId`: 被禁用的用户ID

```javascript
Socket.on('disable', (userId) => {
    if (userId === currentUserId) {
        window.location.replace('/logout');
    }
});
```

## 故障排除

### 常见问题

#### 1. 无法连接到服务器
**症状:** 页面显示"未连接"状态

**解决方案:**
```bash
# 检查服务器是否运行
ps aux | grep node

# 检查端口是否开放
netstat -tlnp | grep :7080

# 检查防火墙设置
sudo ufw status
sudo firewall-cmd --list-ports

# 检查SSL证书
openssl x509 -in ssl/cert.crt -text -noout
```

#### 2. 录制功能不工作
**症状:** 点击录制按钮无反应

**解决方案:**
```javascript
// 检查浏览器支持
if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    console.error('浏览器不支持屏幕录制');
}

// 检查权限
navigator.permissions.query({name: 'camera'}).then(result => {
    console.log('摄像头权限:', result.state);
});
```

#### 3. TURN服务器连接失败
**症状:** WebRTC连接建立失败

**解决方案:**
```bash
# 测试TURN服务器
turnutils_uclient -T -u username -w password server-ip

# 检查TURN服务器日志
tail -f /var/log/turnserver.log

# 检查配置文件
cat turnserver.conf
```

#### 4. 数据库连接错误
**症状:** 登录失败或数据无法保存

**解决方案:**
```bash
# 检查数据库服务
sudo systemctl status mariadb

# 测试数据库连接
mysql -u username -p -h localhost database_name

# 检查数据库配置
cat config.js | grep -A 10 databaseConfig
```

#### 5. 文件上传失败
**症状:** 录制文件无法保存

**解决方案:**
```bash
# 检查存储目录权限
ls -la video/
chmod 755 video/
chown user:user video/

# 检查磁盘空间
df -h

# 检查文件大小限制
grep maxHttpBufferSize app.js
```

### 性能优化

#### 1. 录制性能优化
```javascript
// 调整录制参数
const videoConfig = {
    width: 1280,        // 降低分辨率
    height: 720,
    frameRate: 10,      // 降低帧率
    sliceTime: 5000,    // 增加切片时间
    mimeType: 'video/webm;codecs=vp8'  // 使用VP8编码
};
```

#### 2. 服务器性能优化
```javascript
// Socket.IO优化
const io = new Server(server, {
    pingInterval: 25000,    // 增加心跳间隔
    pingTimeout: 60000,     // 增加超时时间
    maxHttpBufferSize: 5e7, // 限制缓冲区大小
    transports: ['websocket'] // 仅使用WebSocket
});
```

#### 3. 数据库性能优化
```sql
-- 添加索引
CREATE INDEX idx_student_no ON student(stu_no);
CREATE INDEX idx_log_date ON logs(log_date);
CREATE INDEX idx_log_sno ON logs(log_sno);

-- 定期清理日志
DELETE FROM logs WHERE log_date < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 监控和日志

#### 1. 应用监控
```bash
# 使用PM2监控
pm2 monit

# 查看应用日志
pm2 logs webrtc-monitor

# 查看系统资源
htop
iotop
```

#### 2. 日志分析
```bash
# 查看错误日志
grep -i error /var/log/webrtc/*.log

# 查看访问日志
tail -f access.log | grep -E "(POST|GET)"

# 分析连接数
netstat -an | grep :7080 | wc -l
```

#### 3. 性能监控
```bash
# 监控内存使用
free -h

# 监控磁盘IO
iostat -x 1

# 监控网络流量
iftop
```

## 安全注意事项

### 1. 网络安全
- 使用HTTPS加密传输
- 配置防火墙规则
- 定期更新SSL证书
- 限制管理员IP访问

### 2. 数据安全
- 定期备份数据库
- 加密存储敏感信息
- 设置强密码策略
- 定期清理过期文件

### 3. 应用安全
- 输入验证和过滤
- SQL注入防护
- XSS攻击防护
- CSRF令牌验证

## 维护指南

### 1. 定期维护任务
```bash
# 每日任务
- 检查服务状态
- 查看错误日志
- 监控磁盘空间

# 每周任务
- 清理过期录制文件
- 备份数据库
- 更新系统补丁

# 每月任务
- 分析性能数据
- 优化数据库
- 检查安全设置
```

### 2. 备份策略
```bash
# 数据库备份
mysqldump -u root -p webrtc > backup_$(date +%Y%m%d).sql

# 录制文件备份
tar -czf video_backup_$(date +%Y%m%d).tar.gz video/

# 配置文件备份
cp config.js config_backup_$(date +%Y%m%d).js
```

### 3. 更新流程
```bash
# 1. 备份当前版本
cp -r WebRecord WebRecord_backup

# 2. 拉取最新代码
git pull origin main

# 3. 更新依赖
pnpm install

# 4. 重启服务
pm2 restart webrtc-monitor

# 5. 验证功能
curl -k https://localhost:7080/
```

---

## 联系信息

- **项目地址**: https://github.com/vozeo/WebRecord
- **原始项目**: https://github.com/vozeo/RemoteRecord
- **问题反馈**: 请在GitHub Issues中提交
- **技术支持**: 请参考项目文档或社区讨论

---

*本文档最后更新时间: 2024年8月*
