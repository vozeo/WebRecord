# WebRTC监控系统 - 安装配置指南

## 环境要求

### 系统要求
- **操作系统**: Linux (推荐 Ubuntu 20.04+)、macOS 10.15+、Windows 10+
- **Node.js**: >= 18.0.0
- **MySQL/MariaDB**: >= 5.7
- **Redis**: >= 6.0
- **内存**: 最少 2GB，推荐 4GB+
- **存储**: 最少 10GB 可用空间
- **网络**: 稳定的网络连接，支持 HTTPS

### 软件依赖
- **包管理器**: pnpm (推荐) 或 npm
- **数据库**: MySQL 或 MariaDB
- **缓存**: Redis
- **TURN服务器**: Coturn (可选，用于NAT穿透)

## 完整安装步骤

### 第一步：系统环境准备

#### 1.1 安装 Node.js

**Ubuntu/Debian:**
```bash
# 使用 NodeSource 仓库安装最新版本
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

**CentOS/RHEL:**
```bash
# 使用 NodeSource 仓库
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

**macOS:**
```bash
# 使用 Homebrew
brew install node

# 验证安装
node --version
npm --version
```

**Windows:**
- 访问 https://nodejs.org/
- 下载并安装 LTS 版本
- 验证安装：打开命令提示符，运行 `node --version`

#### 1.2 安装 pnpm (推荐)

```bash
# 使用 npm 安装 pnpm
npm install -g pnpm

# 验证安装
pnpm --version
```

#### 1.3 安装 Git

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y git
```

**CentOS/RHEL:**
```bash
sudo yum install -y git
```

**macOS:**
```bash
brew install git
```

### 第二步：数据库安装配置

#### 2.1 安装 MySQL/MariaDB

**使用 Docker (推荐):**
```bash
# 安装 Docker (如果未安装)
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# 启动 MySQL 容器
docker run --name mysql-webrtc -d \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=your_root_password \
  -e MYSQL_DATABASE=webrtc_db \
  -e MYSQL_USER=webrtc_user \
  -e MYSQL_PASSWORD=your_password \
  -v mysql_data:/var/lib/mysql \
  mysql:8.0

# 验证容器运行
docker ps
```

**Ubuntu/Debian 原生安装:**
```bash
sudo apt-get update
sudo apt-get install -y mysql-server

# 启动服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

**CentOS/RHEL 原生安装:**
```bash
sudo yum install -y mariadb-server mariadb

# 启动服务
sudo systemctl start mariadb
sudo systemctl enable mariadb

# 安全配置
sudo mysql_secure_installation
```

#### 2.2 配置数据库

```bash
# 连接到数据库
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE webrtc_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'webrtc_user'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON webrtc_db.* TO 'webrtc_user'@'%';
FLUSH PRIVILEGES;
EXIT;
```

### 第三步：Redis 安装配置

#### 3.1 安装 Redis

**使用 Docker (推荐):**
```bash
# 启动 Redis 容器
docker run --name redis-webrtc -d \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine

# 验证容器运行
docker ps
```

**Ubuntu/Debian 原生安装:**
```bash
sudo apt-get update
sudo apt-get install -y redis-server

# 启动服务
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

**CentOS/RHEL 原生安装:**
```bash
sudo yum install -y redis

# 启动服务
sudo systemctl start redis
sudo systemctl enable redis
```

#### 3.2 验证 Redis 连接

```bash
# 测试 Redis 连接
redis-cli ping
# 应该返回 PONG
```

### 第四步：项目部署

#### 4.1 克隆项目

```bash
# 克隆项目到本地
git clone <repository-url>
cd WebRTC

# 或者下载源码包并解压
# wget <download-url>
# tar -xzf webrtc-monitor.tar.gz
# cd WebRTC
```

#### 4.2 安装项目依赖

```bash
# 使用 pnpm 安装依赖
pnpm install

# 或者使用 npm
npm install
```

#### 4.3 导入数据库结构

```bash
# 导入数据库表结构
mysql -u webrtc_user -p webrtc_db < database.sql

# 导入初始用户数据
mysql -u webrtc_user -p webrtc_db < user.sql
```

### 第五步：SSL 证书配置

#### 5.1 生成自签名证书

```bash
# 创建 SSL 目录
mkdir -p ssl
cd ssl

# 生成自签名证书
openssl req -days 3650 -x509 -newkey rsa:2048 \
  -keyout private.key -out cert.crt -nodes \
  -subj "/C=CN/ST=State/L=City/O=Organization/CN=localhost"

# 返回项目根目录
cd ..
```

#### 5.2 配置 CA 证书 (可选)

如果需要使用自签名证书，需要安装 CA 证书：

```bash
# 运行 CA 证书安装脚本
chmod +x scripts/install_ca_cert.sh
./scripts/install_ca_cert.sh
```

### 第六步：配置文件设置

#### 6.1 修改配置文件

编辑 `config.ts` 文件，配置数据库连接等信息：

```typescript
// 数据库配置
export const dbConfig = {
    host: 'localhost',           // 数据库主机
    port: 3306,                  // 数据库端口
    user: 'webrtc_user',         // 数据库用户名
    password: 'your_password',   // 数据库密码
    database: 'webrtc_db'        // 数据库名
};

// Redis 配置
export const redisConfig = {
    host: 'localhost',           // Redis 主机
    port: 6379,                  // Redis 端口
    password: '',                // Redis 密码（如果有）
    db: 0                        // Redis 数据库编号
};

// 服务器配置
export const serverConfig = {
    port: 7081,                  // 服务器端口
    keyPath: './ssl/private.key', // SSL 私钥路径
    certPath: './ssl/cert.crt',   // SSL 证书路径
    savePath: './recordings',     // 录制文件保存路径
    sessionSecret: 'your-session-secret' // Session 密钥
};
```

#### 6.2 创建录制文件目录

```bash
# 创建录制文件存储目录
mkdir -p recordings
chmod 755 recordings
```

### 第七步：TURN 服务器配置 (可选)

#### 7.1 安装 Coturn

**使用 Docker:**
```bash
# 复制配置文件
cp turnserver_example.conf turnserver.conf

# 编辑配置文件
nano turnserver.conf

# 启动 TURN 服务器
docker run --name coturn -d --network=host \
  -v $(pwd)/turnserver.conf:/etc/coturn/turnserver.conf \
  coturn/coturn
```

**Ubuntu/Debian 原生安装:**
```bash
sudo apt-get install -y coturn

# 复制配置文件
sudo cp turnserver_example.conf /etc/coturn/turnserver.conf

# 编辑配置文件
sudo nano /etc/coturn/turnserver.conf

# 启动服务
sudo systemctl start coturn
sudo systemctl enable coturn
```

#### 7.2 配置 TURN 服务器

编辑 `turnserver.conf` 文件：

```conf
# TURN 服务器配置
listening-port=3478
tls-listening-port=5349

# 认证配置
user=webrtc:password
realm=your-domain.com

# 外部 IP 地址
external-ip=YOUR_PUBLIC_IP

# 日志配置
log-file=/var/log/coturn.log
verbose
```

### 第八步：启动服务

#### 8.1 开发模式启动

```bash
# 开发模式运行（带热重载）
pnpm dev

# 或者使用 npm
npm run dev
```

#### 8.2 生产模式启动

```bash
# 构建项目
pnpm build

# 生产环境运行
pnpm start

# 或者使用 npm
npm run build
npm start
```

#### 8.3 使用 PM2 进程管理 (推荐)

```bash
# 安装 PM2
npm install -g pm2

# 构建项目
pnpm build

# 启动应用
pm2 start dist/app.js --name "webrtc-monitor"

# 设置开机自启
pm2 save
pm2 startup

# 查看日志
pm2 logs webrtc-monitor

# 查看状态
pm2 status
```

### 第九步：验证安装

#### 9.1 检查服务状态

```bash
# 检查应用是否正常运行
curl -k https://localhost:7081/api/information

# 检查数据库连接
mysql -u webrtc_user -p -e "USE webrtc_db; SHOW TABLES;"

# 检查 Redis 连接
redis-cli ping
```

#### 9.2 访问 Web 界面

1. 打开浏览器访问: `https://localhost:7081`
2. 使用默认管理员账户登录:
   - 用户名: `admin`
   - 密码: `admin123`
3. 检查各项功能是否正常

### 第十步：安全配置

#### 10.1 修改默认密码

```bash
# 使用密码重置脚本
node scripts/reset_admin_password.js

# 或者直接修改数据库
mysql -u webrtc_user -p webrtc_db
UPDATE users SET password = 'new_hashed_password' WHERE username = 'admin';
```

#### 10.2 防火墙配置

**Ubuntu/Debian:**
```bash
# 安装 UFW
sudo apt-get install -y ufw

# 配置防火墙规则
sudo ufw allow 7081/tcp
sudo ufw allow 3478/tcp  # TURN 服务器端口
sudo ufw allow 5349/tcp  # TURN TLS 端口
sudo ufw enable
```

**CentOS/RHEL:**
```bash
# 配置防火墙
sudo firewall-cmd --permanent --add-port=7081/tcp
sudo firewall-cmd --permanent --add-port=3478/tcp
sudo firewall-cmd --permanent --add-port=5349/tcp
sudo firewall-cmd --reload
```

## 常见问题解决

### 1. 端口占用问题

```bash
# 查看端口占用
netstat -tulpn | grep 7081

# 杀死占用进程
sudo kill -9 <PID>
```

### 2. 权限问题

```bash
# 修复文件权限
chmod +x scripts/*.sh
chmod 755 recordings/
chmod 600 ssl/private.key
chmod 644 ssl/cert.crt
```

### 3. 数据库连接失败

```bash
# 检查数据库服务状态
sudo systemctl status mysql

# 检查数据库连接
mysql -u webrtc_user -p -h localhost webrtc_db
```

### 4. Redis 连接失败

```bash
# 检查 Redis 服务状态
sudo systemctl status redis

# 测试 Redis 连接
redis-cli -h localhost -p 6379 ping
```

### 5. SSL 证书问题

```bash
# 重新生成证书
cd ssl
openssl req -days 3650 -x509 -newkey rsa:2048 \
  -keyout private.key -out cert.crt -nodes \
  -subj "/C=CN/ST=State/L=City/O=Organization/CN=localhost"
cd ..
```

## 性能优化建议

### 1. 系统优化

```bash
# 增加文件描述符限制
echo "* soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65536" | sudo tee -a /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65535" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65535" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 2. 数据库优化

```sql
-- 优化 MySQL 配置
SET GLOBAL max_connections = 1000;
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
```

### 3. Redis 优化

```bash
# 编辑 Redis 配置
sudo nano /etc/redis/redis.conf

# 添加以下配置
maxmemory 512mb
maxmemory-policy allkeys-lru
```

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u webrtc_user -p webrtc_db > backup_${DATE}.sql
tar -czf backup_${DATE}.tar.gz backup_${DATE}.sql recordings/
rm backup_${DATE}.sql
echo "Backup completed: backup_${DATE}.tar.gz"
EOF

chmod +x backup.sh
```

### 2. 恢复数据

```bash
# 恢复数据库
mysql -u webrtc_user -p webrtc_db < backup_20231201_120000.sql

# 恢复文件
tar -xzf backup_20231201_120000.tar.gz
```

## 监控和维护

### 1. 日志监控

```bash
# 查看应用日志
pm2 logs webrtc-monitor

# 查看系统日志
sudo journalctl -u mysql
sudo journalctl -u redis
```

### 2. 性能监控

```bash
# 安装监控工具
sudo apt-get install -y htop iotop

# 监控系统资源
htop
iotop
```

### 3. 定期维护

```bash
# 创建维护脚本
cat > maintenance.sh << 'EOF'
#!/bin/bash
# 清理旧日志
find /var/log -name "*.log" -mtime +30 -delete

# 清理临时文件
rm -rf /tmp/*

# 重启服务
pm2 restart webrtc-monitor
EOF

chmod +x maintenance.sh

# 添加到 crontab
echo "0 2 * * 0 /path/to/maintenance.sh" | crontab -
```

## 故障排除

### 1. 服务无法启动

```bash
# 检查错误日志
pm2 logs webrtc-monitor --err

# 检查配置文件
node -c config.ts

# 检查依赖
pnpm install --force
```

### 2. WebRTC 连接失败

```bash
# 检查 TURN 服务器
telnet your-turn-server 3478

# 检查防火墙
sudo ufw status
```

### 3. 录制文件上传失败

```bash
# 检查磁盘空间
df -h

# 检查文件权限
ls -la recordings/

# 检查网络连接
ping your-server
```

---

**注意**: 请根据实际环境调整配置参数，确保所有服务正常运行后再进行生产部署。 