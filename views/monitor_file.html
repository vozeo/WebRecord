{{extend './template.html'}}

{{block 'title'}}文件监控{{/block}}

{{block 'head'}}
<style>
    /* table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    th {
        background-color: #f2f2f2;
    } */
    .error {
        color: red;
    }
</style>
{{/block}}

{{block 'content'}}
<section id="features">
    <div id="error" class="error"></div>
    <div class="col-10 container-fluid text-center">
        <table id="monitorTable" class="table">
            <thead>
                <tr>
                    <th>学号</th>
                    <th>最新修改时间</th>
                    <th>时间差(s)</th>
                    <th>是否小于阈值</th>
                    <th>文件大小</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</section>
{{/block}}

{{block 'script'}}
<script>
    async function fetchData() {
        try {
            const response = await fetch('/record_file_list');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
            window.location.replace('/');
            return { error: error.message };
        }
    }

    function updateTable(data) {
        const tableBody = document.querySelector('#monitorTable tbody');
        const errorDiv = document.querySelector('#error');
        tableBody.innerHTML = '';
        errorDiv.textContent = '';

        if (data.error) {
            errorDiv.textContent = `Error: ${data.error}`;
            return;
        }

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.studentId}</td>
                <td>${row.modificationTimeStr}</td>
                <td>${row.timeDiff.toFixed(2)}</td>
                <td class="${row.isBelowThreshold ? 'bg-success' : ''}">${row.isBelowThreshold ? '是' : '否'}</td>
                <td>${row.fileSize}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    async function refreshData() {
        const data = await fetchData();
        updateTable(data);
    }

    setInterval(refreshData, 1000);
    refreshData();
</script>
{{/block}}