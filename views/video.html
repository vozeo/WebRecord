<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>å®æ—¶è§†é¢‘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-connecting {
            background: #ffc107;
            color: #000;
        }
        .status-connected {
            background: #28a745;
            color: #fff;
        }
        .status-error {
            background: #dc3545;
            color: #fff;
        }
        .control-panel {
            margin-top: 20px;
        }
    </style>
</head>
<body id="page-top">
    <div class="container-fluid p-3">
        <div class="row">
            <div class="col-12 text-center">
                <h3 id="video-title">å®æ—¶è§†é¢‘ç›‘æ§</h3>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="video-container">
                    <video id="remoteVideo" autoplay muted class="w-100" style="min-height: 400px; max-height: 70vh;"></video>
                    <div id="status-indicator" class="status-indicator status-connecting">è¿æ¥ä¸­...</div>
                </div>
                <div class="control-panel text-center">
                    <button id="reconnect-btn" class="btn btn-primary" onclick="reconnect()" style="display: none;">é‡æ–°è¿æ¥</button>
                    <button id="close-btn" class="btn btn-secondary" onclick="closeWindow()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/public/js/template.js"></script>
    <script>
        // ä»URLè·å–å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        const streamType = urlParams.get('type');

        let peer = null;
        let socket = null;
        let networkConfig = null;
        let sessionUser = null;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 3;

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        if (studentId && streamType) {
            document.getElementById('video-title').textContent =
                `å­¦å·: ${studentId} - ${streamType === 'screen' ? 'å±å¹•' : 'æ‘„åƒå¤´'}ç›‘æ§`;
        }

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(status, message) {
            const indicator = document.getElementById('status-indicator');
            const reconnectBtn = document.getElementById('reconnect-btn');

            indicator.className = `status-indicator status-${status}`;
            indicator.textContent = message;

            if (status === 'error') {
                reconnectBtn.style.display = 'inline-block';
            } else {
                reconnectBtn.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            try {
                console.log('ğŸ¥ åˆå§‹åŒ–å®æ—¶ç›‘æ§é¡µé¢...');

                // è·å–é…ç½®ä¿¡æ¯
                const response = await fetch('/api/information');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'è·å–é…ç½®ä¿¡æ¯å¤±è´¥');
                }

                networkConfig = data.data.networkConfig;
                sessionUser = data.data.sessionUser;

                if (!sessionUser || sessionUser.stu_userlevel < 1) {
                    throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æŸ¥çœ‹å®æ—¶è§†é¢‘');
                }

                console.log('âœ… é…ç½®ä¿¡æ¯è·å–æˆåŠŸ');

                // å»ºç«‹è¿æ¥
                await setupConnections();

            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                const message = error.response?.data?.message || error.message || 'åˆå§‹åŒ–å¤±è´¥';
                updateStatus('error', `åˆå§‹åŒ–å¤±è´¥: ${message}`);
                
                // å¦‚æœæœ‰templateç³»ç»Ÿï¼Œä¹Ÿæ˜¾ç¤ºé”™è¯¯æç¤º
                if (window.templateSystem && window.templateSystem.showError) {
                    window.templateSystem.showError(`è§†é¢‘ç›‘æ§åˆå§‹åŒ–å¤±è´¥: ${message}`);
                }
            }
        }

        // å»ºç«‹è¿æ¥
        async function setupConnections() {
            try {
                updateStatus('connecting', 'æ­£åœ¨è¿æ¥...');

                // å»ºç«‹Socketè¿æ¥
                await setupSocketConnection();

                // å»ºç«‹WebRTCè¿æ¥
                await setupWebRTCConnection();

            } catch (error) {
                console.error('âŒ è¿æ¥å»ºç«‹å¤±è´¥:', error);
                const message = error.response?.data?.message || error.message || 'è¿æ¥å¤±è´¥';
                updateStatus('error', `è¿æ¥å¤±è´¥: ${message}`);
                
                if (window.templateSystem && window.templateSystem.showError) {
                    window.templateSystem.showError(`æ— æ³•å»ºç«‹è¿æ¥: ${message}`);
                }
                throw error;
            }
        }

        // å»ºç«‹Socketè¿æ¥
        function setupSocketConnection() {
            return new Promise((resolve, reject) => {
                const socketUrl = `https://${window.location.hostname}:${networkConfig.socketPort}`;

                socket = io(socketUrl, {
                    rejectUnauthorized: false,
                    timeout: 20000,
                    forceNew: true,
                    transports: ['polling', 'websocket'],
                    upgrade: true,
                    withCredentials: true
                });

                socket.on('connect', () => {
                    console.log('âœ… Socketè¿æ¥æˆåŠŸ');

                    // å‘é€ç›‘æ§è¯·æ±‚
                    socket.emit('watch', sessionUser.stu_no, studentId);
                    resolve();
                });

                socket.on('connect_error', (error) => {
                    console.error('âŒ Socketè¿æ¥å¤±è´¥:', error);
                    const message = error.message || 'Socketè¿æ¥å¤±è´¥';
                    reject(new Error(message));
                });

                socket.on('disconnect', (reason) => {
                    console.log('âŒ Socketè¿æ¥æ–­å¼€:', reason);
                    updateStatus('error', 'Socketè¿æ¥æ–­å¼€');
                });
            });
        }

        // å»ºç«‹WebRTCè¿æ¥
        function setupWebRTCConnection() {
            return new Promise((resolve, reject) => {
                try {
                    // åˆ›å»ºPeerè¿æ¥
                    const peerId = `monitor-${sessionUser.stu_no}-${Date.now()}`;

                    peer = new Peer(peerId, {
                        host: window.location.hostname,
                        port: networkConfig.socketPort,
                        path: "/webrtc",
                        secure: true,
                        config: {
                            'iceServers': [
                                { urls: 'stun:stun.l.google.com:19302' },
                                {
                                    urls: `turn:${window.location.hostname}:${networkConfig.turnServerPort}`,
                                    username: networkConfig.turnServerUsername,
                                    credential: networkConfig.turnServerCredential
                                }
                            ]
                        }
                    });

                    peer.on('open', (id) => {
                        console.log('âœ… Peerè¿æ¥å»ºç«‹æˆåŠŸ, ID:', id);

                        // å°è¯•è¿æ¥åˆ°å­¦ç”Ÿç«¯
                        connectToStudent();
                        resolve();
                    });

                    peer.on('error', (error) => {
                        console.error('âŒ Peerè¿æ¥é”™è¯¯:', error);
                        reject(new Error(`Peerè¿æ¥å¤±è´¥: ${error.message}`));
                    });

                    peer.on('call', (call) => {
                        console.log('ğŸ“ æ”¶åˆ°æ¥ç”µ');
                        call.answer(); // æ¥å¬æ¥ç”µ

                        call.on('stream', (remoteStream) => {
                            console.log('ğŸ¥ æ”¶åˆ°è¿œç¨‹è§†é¢‘æµ');
                            const video = document.getElementById('remoteVideo');
                            video.srcObject = remoteStream;
                            updateStatus('connected', 'è¿æ¥æˆåŠŸ');
                        });

                        call.on('error', (error) => {
                            console.error('âŒ é€šè¯é”™è¯¯:', error);
                            updateStatus('error', `é€šè¯é”™è¯¯: ${error.message}`);
                        });

                        call.on('close', () => {
                            console.log('ğŸ“ é€šè¯ç»“æŸ');
                            updateStatus('error', 'è¿æ¥å·²æ–­å¼€');
                        });
                    });

                } catch (error) {
                    console.error('âŒ WebRTCåˆå§‹åŒ–å¤±è´¥:', error);
                    reject(error);
                }
            });
        }

        // è¿æ¥åˆ°å­¦ç”Ÿç«¯
        function connectToStudent() {
            try {
                // æ„å»ºå­¦ç”Ÿç«¯çš„Peer ID
                // æ ¹æ®æ—§ä»£ç ï¼Œå­¦ç”Ÿç«¯çš„IDæ ¼å¼æ˜¯: å­¦å· + ç±»å‹ + è®¾å¤‡ID
                // æˆ‘ä»¬éœ€è¦å°è¯•è¿æ¥åˆ°å­¦ç”Ÿç«¯

                console.log('ğŸ” å°è¯•è¿æ¥åˆ°å­¦ç”Ÿç«¯...');

                // ç”±äºæˆ‘ä»¬ä¸çŸ¥é“ç¡®åˆ‡çš„è®¾å¤‡IDï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡Socketé€šçŸ¥å­¦ç”Ÿç«¯å»ºç«‹è¿æ¥
                // æˆ–è€…å°è¯•ä¸€äº›å¸¸è§çš„è¿æ¥æ–¹å¼

                setTimeout(() => {
                    // å¦‚æœä¸€æ®µæ—¶é—´åè¿˜æ²¡æœ‰è¿æ¥æˆåŠŸï¼Œæ˜¾ç¤ºé”™è¯¯
                    if (document.getElementById('status-indicator').textContent === 'æ­£åœ¨è¿æ¥...') {
                        updateStatus('error', 'æ— æ³•è¿æ¥åˆ°å­¦ç”Ÿç«¯ï¼Œè¯·ç¡®ä¿å­¦ç”Ÿæ­£åœ¨å½•åˆ¶');
                    }
                }, 10000);

            } catch (error) {
                console.error('âŒ è¿æ¥å­¦ç”Ÿç«¯å¤±è´¥:', error);
                updateStatus('error', `è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // é‡æ–°è¿æ¥
        async function reconnect() {
            connectionAttempts++;

            if (connectionAttempts > maxConnectionAttempts) {
                updateStatus('error', 'è¿æ¥å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åé‡è¯•');
                return;
            }

            console.log(`ğŸ”„ å°è¯•é‡æ–°è¿æ¥ (${connectionAttempts}/${maxConnectionAttempts})`);

            // æ¸…ç†ç°æœ‰è¿æ¥
            if (peer) {
                peer.destroy();
                peer = null;
            }

            if (socket) {
                socket.disconnect();
                socket = null;
            }

            // é‡æ–°å»ºç«‹è¿æ¥
            try {
                await setupConnections();
            } catch (error) {
                console.error('âŒ é‡æ–°è¿æ¥å¤±è´¥:', error);
                const message = error.response?.data?.message || error.message || 'é‡æ–°è¿æ¥å¤±è´¥';
                updateStatus('error', `é‡æ–°è¿æ¥å¤±è´¥: ${message}`);
                
                if (window.templateSystem && window.templateSystem.showError) {
                    window.templateSystem.showError(`é‡æ–°è¿æ¥å¤±è´¥: ${message}`);
                }
            }
        }

        // å…³é—­çª—å£
        function closeWindow() {
            if (peer) {
                peer.destroy();
            }
            if (socket) {
                socket.disconnect();
            }
            window.close();
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (peer) {
                peer.destroy();
            }
            if (socket) {
                socket.disconnect();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¥ å®æ—¶ç›‘æ§é¡µé¢åŠ è½½å®Œæˆ');
            initialize();
        });
    </script>
</body>
</html>