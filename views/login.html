<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>登录</title>
</head>

<body id="page-top">
    <!-- 导航栏将通过template.js自动添加 -->
    
    <section class="vh-100">
        <div class="container py-5 h-100">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col col-xl-10">
                    <div class="card" style="border-radius: 2rem;">
                        <div class="row g-0">
                            <div class="col-md-6 col-lg-5 d-none d-md-block">
                                <img id="background-image" alt="Tongji University" class="img-fluid"
                                    style="border-radius: 2rem 0 0 2rem;" />
                            </div>
                            <div class="col-md-6 col-lg-6 px-4 d-flex align-items-center">
                                <div class="card-body p-4 p-lg-3 text-black">
                                    <form id="loginForm">
                                        <div class="d-flex align-items-center mb-3 pb-1">
                                            <span class="h1 fw-bold mb-0">同济远程录屏系统</span>
                                        </div>
                                        <h5 class="fw-normal mb-3 pb-3" style="letter-spacing: 1px;">登录</h5>
                                        <div class="form-outline mb-4">
                                            <input type="text" id="username" class="form-control form-control-lg"
                                                required />
                                            <label class="form-label" for="username">用户名</label>
                                        </div>
                                        <div class="form-outline mb-4">
                                            <input type="password" id="password" class="form-control form-control-lg"
                                                required />
                                            <label class="form-label" for="password">密码</label>
                                        </div>
                                        <div class="pt-1 mb-4">
                                            <button class="btn btn-dark btn-lg btn-block" type="submit">登录</button>
                                        </div>
                                        <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                                        <div id="success-message" class="alert alert-success" style="display: none;"></div>
                                        <p class="mb-5 pb-lg-2" style="color: #393f81;">
                                            忘记密码？<a href="/password" style="color: #393f81;">点击这里修改</a>
                                        </p>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="/public/js/template.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 设置随机背景图片
            const imageCount = 8; // 假设有8张图片
            const randomImage = Math.floor(Math.random() * imageCount) + 1;
            document.getElementById('background-image').src = `../images/${randomImage}.jpg`;

            // 检查是否已经登录，如果已登录则自动跳转
            try {
                const response = await axios.get('/api/check-auth');
                if (response.data.success && response.data.data.isAuthenticated) {
                    const user = response.data.data.user;
                    const userLevel = parseInt(user.stu_userlevel || '0');

                    // 所有已登录用户都跳转到主页
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                // 如果检查失败，继续显示登录页面
                console.log('用户未登录，显示登录页面');
            }

            // 登录表单处理
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                
                // 隐藏之前的消息
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                
                if (!username || !password) {
                    errorDiv.textContent = '请输入用户名和密码';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // 显示加载状态
                if (window.templateSystem) {
                    window.templateSystem.showLoading('正在登录...');
                }
                
                try {
                    const response = await axios.post('/api/login', {
                        stu_no: username,
                        password: password
                    });
                    
                    if (response.data.success) {
                        successDiv.textContent = '登录成功，正在跳转...';
                        successDiv.style.display = 'block';
                        setTimeout(() => {
                            // 使用服务器返回的重定向URL，如果没有则默认跳转到首页
                            const redirectUrl = response.data.data?.redirectUrl || '/';
                            window.location.href = redirectUrl;
                        }, 1000);
                    } else {
                        errorDiv.textContent = response.data.message || '登录失败';
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('登录错误:', error);
                    const message = error.response?.data?.message || '网络错误，请重试';
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                } finally {
                    // 隐藏加载状态
                    if (window.templateSystem) {
                        window.templateSystem.hideLoading();
                    }
                }
            });
        });
    </script>
</body>

</html>