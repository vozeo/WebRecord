<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>ä¸»é¡µ</title>
</head>

<body id="page-top">
    <!-- å¯¼èˆªæ å’Œé¡µè„šå°†é€šè¿‡template.jsè‡ªåŠ¨æ·»åŠ  -->
    
    <section id="features">
        <h1 id="sentence" class="mt-5 mb-3 text-center"></h1>
        <p id="info" class="me-5" style="text-align: right;"></p>
        <div></div>
        <div class="container-fluid text-center p-5" id="main-buttons" style="display:none;">
    
            <a type="button" class="btn btn-warning btn-lg" href="/record" id="record-btn" style="display:none;">è¿›å…¥å½•åˆ¶</a>
            <a type="button" class="btn btn-warning btn-lg" href="/monitor" id="monitor-btn" style="display:none;">è¿›å…¥ç›‘æ§</a>
            <a style="display: none;" type="button" class="btn btn-info btn-lg" href="/history" target="_blank">å†å²è§†é¢‘</a>
        </div>
    </section>

    <script src="/public/js/template.js"></script>

    <script>
        // ç­‰å¾…loggeråŠ è½½å®Œæˆåå¼€å§‹æ‰§è¡Œ
        function waitForLogger() {
            return new Promise(resolve => {
                const checkLogger = () => {
                    if (window.logger) resolve();
                    else setTimeout(checkLogger, 100);
                };
                checkLogger();
            });
        }

        (async () => {
            await waitForLogger();
            window.logger.debug('HomePage', 'ä¸»é¡µè„šæœ¬å¼€å§‹æ‰§è¡Œ, readyState:', document.readyState);
        })();
    </script>

    <script>
        // ä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼ç­‰å¾…DOMå’Œæ¨¡æ¿ç³»ç»Ÿ
        function initializePage() {
            console.log('ğŸ  å¼€å§‹åˆå§‹åŒ–ä¸»é¡µ...');

            if (window.templateSystem && window.templateSystem.isInitialized) {
                console.log('ğŸ  æ¨¡æ¿ç³»ç»Ÿå·²å°±ç»ªï¼Œæ›´æ–°é¡µé¢å†…å®¹');
                updatePageContent();
                loadTodayPoetry();
            } else {
                console.log('ğŸ  ç­‰å¾…æ¨¡æ¿ç³»ç»Ÿåˆå§‹åŒ–...');
                setTimeout(initializePage, 200);
            }
        }

        // DOMåŠ è½½å®Œæˆåå¼€å§‹åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('ğŸ  DOMåŠ è½½å®Œæˆ');
                initializePage();
            });
        } else {
            console.log('ğŸ  DOMå·²å°±ç»ª');
            initializePage();
        }

        // ç«‹å³å°è¯•åˆå§‹åŒ–ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        setTimeout(() => {
            console.log('ğŸ  5ç§’åå¼ºåˆ¶åˆå§‹åŒ–...');
            initializePage();
        }, 5000);

        // åŠ è½½ä»Šæ—¥è¯—è¯
        function loadTodayPoetry() {
            try {
                // åŠ¨æ€åŠ è½½è¯—è¯API
                const script = document.createElement('script');
                script.src = 'https://sdk.jinrishici.com/v2/browser/jinrishici.js';
                script.charset = 'utf-8';
                script.onload = () => {
                    if (typeof jinrishici !== 'undefined') {
                        const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
                        jinrishici.load(result => {
                            const sentence = document.querySelector("#sentence");
                            const info = document.querySelector("#info");
                            if (sentence && info && result && result.data) {
                                sentence.innerHTML = result.data.content;
                                info.innerHTML = `â€”â€”ã€${result.data.origin.dynasty}ã€‘${result.data.origin.author}ã€Š${result.data.origin.title}ã€‹`;
                                sentence.style.color = info.style.color = randomColor;
                            }
                        });
                    }
                };
                script.onerror = () => {
                    console.log('è¯—è¯APIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹');
                    const sentence = document.querySelector("#sentence");
                    const info = document.querySelector("#info");
                    if (sentence && info) {
                        sentence.innerHTML = 'æ¬¢è¿ä½¿ç”¨è¿œç¨‹å½•å±ç³»ç»Ÿ';
                        info.innerHTML = '';
                    }
                };
                document.head.appendChild(script);
            } catch (error) {
                console.log('è¯—è¯åŠ è½½å‡ºé”™:', error);
            }
        }

        function updatePageContent() {
            const sessionUser = window.templateSystem.sessionUser;

            console.log('ğŸ  ä¸»é¡µæ›´æ–°å†…å®¹ - sessionUser:', sessionUser);
            console.log('ğŸ  templateSystemçŠ¶æ€:', window.templateSystem);

            if (sessionUser) {
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºæŒ‰é’®');
                document.getElementById('main-buttons').style.display = 'block';

                // æ ¹æ®ç”¨æˆ·çº§åˆ«æ˜¾ç¤ºä¸åŒæŒ‰é’®
                const userLevel = parseInt(sessionUser.stu_userlevel || '0');
                console.log('ğŸ‘¤ ç”¨æˆ·çº§åˆ«:', userLevel);

                // æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¾ç¤ºå½•åˆ¶æŒ‰é’®
                document.getElementById('record-btn').style.display = 'inline-block';

                if (userLevel >= 1) {
                    // ç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜è¿˜æ˜¾ç¤ºç›‘æ§æŒ‰é’®
                    document.getElementById('monitor-btn').style.display = 'inline-block';
                    console.log('ğŸ”§ ç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ˜¾ç¤ºç›‘æ§æŒ‰é’®');
                } else {
                    // æ™®é€šç”¨æˆ·ä¸æ˜¾ç¤ºç›‘æ§æŒ‰é’®
                    document.getElementById('monitor-btn').style.display = 'none';
                    console.log('ğŸ‘¨â€ğŸ“ æ™®é€šç”¨æˆ·ï¼Œéšè—ç›‘æ§æŒ‰é’®');
                }
            } else {
                console.log('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œéšè—æ‰€æœ‰æŒ‰é’®');
                document.getElementById('main-buttons').style.display = 'none';
            }
        }
    </script>
</body>

</html>