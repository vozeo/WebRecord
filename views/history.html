<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>å†å²è§†é¢‘æŸ¥çœ‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .video-controls {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .student-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #fff;
        }
        
        .student-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }
        
        .file-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .file-item:hover {
            background-color: #f8f9fa;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .file-info {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .no-files {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn-play {
            background: #28a745;
            border: none;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .btn-download {
            background: #17a2b8;
            border: none;
            color: white;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .current-playing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .video-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 60px;
            text-align: center;
            color: #6c757d;
            margin-bottom: 20px;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
        }
        
        .tab-content {
            background: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 20px;
        }
    </style>
</head>
<body id="page-top">
    <!-- å¯¼èˆªæ å’Œé¡µè„šå°†é€šè¿‡template.jsè‡ªåŠ¨æ·»åŠ  -->

    <div class="container-fluid p-4">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-play-circle-fill me-2"></i>å†å²è§†é¢‘æŸ¥çœ‹</h2>
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshFiles()">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="goBack()">
                            <i class="bi bi-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card">
                    <div class="row">
                        <div class="col-md-3">
                            <h5 class="mb-1" id="total-students">0</h5>
                            <small>å­¦ç”Ÿæ•°é‡</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="mb-1" id="total-files">0</h5>
                            <small>è§†é¢‘æ–‡ä»¶</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="mb-1" id="total-size">0 MB</h5>
                            <small>æ€»å¤§å°</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="mb-1" id="last-updated">-</h5>
                            <small>æœ€è¿‘æ›´æ–°</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <ul class="nav nav-tabs" id="historyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-panel" type="button" role="tab" aria-controls="video-panel" aria-selected="true">
                    <i class="bi bi-play-circle me-1"></i>è§†é¢‘æ’­æ”¾
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monitor-tab" data-bs-toggle="tab" data-bs-target="#monitor-panel" type="button" role="tab" aria-controls="monitor-panel" aria-selected="false">
                    <i class="bi bi-activity me-1"></i>å½•åˆ¶çŠ¶æ€
                </button>
            </li>
        </ul>

        <!-- æ ‡ç­¾é¡µå†…å®¹ -->
        <div class="tab-content" id="historyTabContent">
            <!-- è§†é¢‘æ’­æ”¾æ ‡ç­¾é¡µ -->
            <div class="tab-pane fade show active" id="video-panel" role="tabpanel" aria-labelledby="video-tab">
                <div class="row">
                    <!-- æ–‡ä»¶åˆ—è¡¨ -->
                    <div class="col-md-4">
                        <!-- æœç´¢æ¡† -->
                        <div class="search-box">
                            <input type="text" class="form-control" id="search-input" placeholder="æœç´¢å­¦ç”Ÿå§“åæˆ–å­¦å·...">
                        </div>

                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div class="loading-spinner text-center" id="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨åŠ è½½å†å²æ–‡ä»¶...</p>
                        </div>

                        <!-- æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
                        <div id="files-container">
                            <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                        </div>

                        <!-- æ— æ–‡ä»¶æç¤º -->
                        <div class="no-files" id="no-files" style="display: none;">
                            <i class="bi bi-camera-video display-1 text-muted"></i>
                            <h5 class="mt-3">æš‚æ— å½•åˆ¶æ–‡ä»¶</h5>
                            <p>ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•å½•åˆ¶çš„è§†é¢‘æ–‡ä»¶</p>
                        </div>
                    </div>

                    <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
                    <div class="col-md-8">
                        <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
                        <div class="current-playing" id="current-playing" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-play-circle-fill text-success me-2"></i>
                                <div>
                                    <strong id="current-file-name">-</strong>
                                    <br>
                                    <small class="text-muted" id="current-student-info">-</small>
                                </div>
                                <div class="ms-auto">
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadCurrentFile()">
                                        <i class="bi bi-download"></i> ä¸‹è½½
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteCurrentFile()">
                                        <i class="bi bi-trash"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- è§†é¢‘æ’­æ”¾å™¨ -->
                        <div class="video-container">
                            <video id="video-player" controls class="w-100" style="min-height: 400px; max-height: 70vh; display: none;">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                            
                            <!-- è§†é¢‘å ä½ç¬¦ -->
                            <div class="video-placeholder" id="video-placeholder">
                                <i class="bi bi-camera-video display-1"></i>
                                <h5 class="mt-3">é€‰æ‹©è§†é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾</h5>
                                <p>è¯·ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©è¦æ’­æ”¾çš„è§†é¢‘æ–‡ä»¶</p>
                            </div>
                        </div>

                        <!-- è§†é¢‘æ§åˆ¶ä¿¡æ¯ -->
                        <div class="video-controls" id="video-controls" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span id="video-info">-</span>
                                    </small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small>
                                        <i class="bi bi-clock me-1"></i>
                                        <span id="video-duration">-</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å½•åˆ¶çŠ¶æ€æ ‡ç­¾é¡µ -->
            <div class="tab-pane fade" id="monitor-panel" role="tabpanel" aria-labelledby="monitor-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>å½•åˆ¶çŠ¶æ€å®æ—¶ç›‘æ§</h4>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadRecordingStatus()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
                <div id="recording-status-container">
                    <!-- å½•åˆ¶çŠ¶æ€æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <script src="/public/js/template.js"></script>
    <script>
        let recordedFiles = {};
        let currentFileUrl = null;
        let currentFileName = null;
        let currentStudentId = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“ å†å²è§†é¢‘é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç­‰å¾…æ¨¡æ¿ç³»ç»Ÿåˆå§‹åŒ–
            await new Promise(resolve => {
                const checkTemplate = () => {
                    if (window.templateSystem) {
                        resolve();
                    } else {
                        setTimeout(checkTemplate, 100);
                    }
                };
                checkTemplate();
            });

            // æ£€æŸ¥æƒé™å¹¶åˆå§‹åŒ–
            const userLevel = parseInt(window.templateSystem.sessionUser?.stu_userlevel || '0');
            if (!window.templateSystem.sessionUser || userLevel < 1) {
                window.templateSystem.showError('è®¿é—®è¢«æ‹’ç»ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            initialize();
            setupEventListeners();
            setupTabEventListeners();
        });

        // åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            try {
                console.log('ğŸ” å¼€å§‹åŠ è½½å†å²æ–‡ä»¶åˆ—è¡¨...');
                showLoading(true);
                
                await loadRecordedFiles();
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                const message = error.message || 'åˆå§‹åŒ–å¤±è´¥';
                
                // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œè·³è½¬åˆ°é¦–é¡µ
                if (error.status === 403 || message.includes('æƒé™')) {
                    window.templateSystem.showError('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å†å²è§†é¢‘');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
                
                window.templateSystem.showError(`å†å²è§†é¢‘åŠ è½½å¤±è´¥: ${message}`);
                showError(message);
            } finally {
                showLoading(false);
            }
        }

        // è®¾ç½®æ ‡ç­¾é¡µäº‹ä»¶ç›‘å¬å™¨
        function setupTabEventListeners() {
            // ç›‘å¬æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.getElementById('monitor-tab').addEventListener('shown.bs.tab', function (e) {
                loadRecordingStatus();
                // å¼€å§‹å®šæ—¶åˆ·æ–°
                if (window.monitorInterval) {
                    clearInterval(window.monitorInterval);
                }
                window.monitorInterval = setInterval(loadRecordingStatus, 5000);
            });

            document.getElementById('video-tab').addEventListener('shown.bs.tab', function (e) {
                // åœæ­¢å®šæ—¶åˆ·æ–°
                if (window.monitorInterval) {
                    clearInterval(window.monitorInterval);
                    window.monitorInterval = null;
                }
            });
        }

        // åŠ è½½å½•åˆ¶æ–‡ä»¶åˆ—è¡¨
        async function loadRecordedFiles() {
            try {
                const response = await fetch('/api/recorded-files');
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    if (response.status === 403) {
                        const error = new Error('æƒé™ä¸è¶³ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™');
                        error.status = 403;
                        throw error;
                    }
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                }

                recordedFiles = data.data || {};
                console.log('âœ… æ–‡ä»¶åˆ—è¡¨åŠ è½½æˆåŠŸ:', Object.keys(recordedFiles).length, 'ä¸ªå­¦ç”Ÿ');
                
                renderFilesList();
                updateStats();
                
            } catch (error) {
                console.error('âŒ åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                
                // æƒé™é”™è¯¯ç‰¹æ®Šå¤„ç†
                if (error.status === 403) {
                    throw error;
                }
                
                throw new Error(`åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`);
            }
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFilesList() {
            const container = document.getElementById('files-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (Object.keys(recordedFiles).length === 0) {
                document.getElementById('no-files').style.display = 'block';
                container.innerHTML = '';
                return;
            }

            document.getElementById('no-files').style.display = 'none';
            
            let html = '';
            
            // æŒ‰å­¦å·æ’åº
            const sortedStudents = Object.keys(recordedFiles).sort();
            
            for (const studentId of sortedStudents) {
                const studentData = recordedFiles[studentId];
                const studentName = studentData.studentName;
                
                // æœç´¢è¿‡æ»¤
                if (searchTerm && 
                    !studentId.includes(searchTerm) && 
                    !studentName.toLowerCase().includes(searchTerm)) {
                    continue;
                }
                
                html += `
                    <div class="student-card">
                        <div class="student-header">
                            <h6 class="mb-1">
                                <i class="bi bi-person-fill me-2"></i>
                                ${studentName}
                            </h6>
                            <small class="text-muted">å­¦å·: ${studentId} | ${studentData.files.length} ä¸ªæ–‡ä»¶</small>
                        </div>
                `;
                
                for (const file of studentData.files) {
                    const fileId = `${studentId}_${file.name}`;
                    const recordTime = new Date(file.modificationTime).toLocaleString('zh-CN');
                    
                    html += `
                        <div class="file-item" data-student-id="${studentId}" data-file-name="${file.name}" 
                             data-play-url="${file.playUrl}" data-download-url="${file.downloadUrl}"
                             onclick="playVideo('${studentId}', '${file.name}', '${file.playUrl}', '${file.downloadUrl}')">
                            <div class="d-flex align-items-center">
                                <button class="btn-play">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${file.name}</div>
                                    <div class="file-info">
                                        <i class="bi bi-calendar me-1"></i>${recordTime} |
                                        <i class="bi bi-file-earmark me-1"></i>${file.size}
                                    </div>
                                </div>
                                <button class="btn-download" onclick="downloadFile(event, '${file.downloadUrl}', '${file.name}')">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // æ’­æ”¾è§†é¢‘
        async function playVideo(studentId, fileName, playUrl, downloadUrl) {
            try {
                console.log('ğŸ¥ å¼€å§‹æ’­æ”¾è§†é¢‘:', fileName);
                
                // æ›´æ–°å½“å‰æ’­æ”¾ä¿¡æ¯
                currentStudentId = studentId;
                currentFileName = fileName;
                currentFileUrl = downloadUrl;
                
                // æ›´æ–°UIçŠ¶æ€
                updateActiveFileItem(studentId, fileName);
                showCurrentPlaying(studentId, fileName);
                
                // è®¾ç½®è§†é¢‘æº
                const videoPlayer = document.getElementById('video-player');
                const videoPlaceholder = document.getElementById('video-placeholder');
                const videoControls = document.getElementById('video-controls');
                
                // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                videoPlayer.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                videoControls.style.display = 'block';
                
                // è®¾ç½®è§†é¢‘äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¤„ç†WebRecorderæ–‡ä»¶ç‰¹æ®Šæ€§ï¼‰
                setupVideoEventListeners(videoPlayer, fileName);
                
                // è®¾ç½®è§†é¢‘æº
                videoPlayer.src = playUrl;
                
                // æ›´æ–°è§†é¢‘ä¿¡æ¯
                updateVideoInfo(fileName);
                
                console.log('âœ… è§†é¢‘è®¾ç½®å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ’­æ”¾è§†é¢‘å¤±è´¥:', error);
                const message = error.message || 'æ’­æ”¾å¤±è´¥';
                window.templateSystem.showError(`è§†é¢‘æ’­æ”¾å¤±è´¥: ${message}`);
            }
        }

        // è®¾ç½®è§†é¢‘æ’­æ”¾å™¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¤„ç†WebRecorderæ–‡ä»¶ç‰¹æ®Šæ€§ï¼‰
        function setupVideoEventListeners(videoPlayer, fileName) {
            // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            const newVideoPlayer = videoPlayer.cloneNode(true);
            videoPlayer.parentNode.replaceChild(newVideoPlayer, videoPlayer);
            
            // é‡æ–°è·å–å…ƒç´ å¼•ç”¨
            const player = document.getElementById('video-player');
            
            let hasValidDuration = false;
            let loadStartTime = Date.now();
            
            // ç›‘å¬å…ƒæ•°æ®åŠ è½½
            player.addEventListener('loadedmetadata', () => {
                console.log('ğŸ“Š è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ');
                const duration = player.duration;
                
                if (duration && !isNaN(duration) && isFinite(duration)) {
                    hasValidDuration = true;
                    const formattedDuration = formatDuration(duration);
                    document.getElementById('video-duration').textContent = `æ—¶é•¿: ${formattedDuration}`;
                    console.log('âœ… è§†é¢‘æ—¶é•¿ä¿¡æ¯æœ‰æ•ˆ:', formattedDuration);
                } else {
                    hasValidDuration = false;
                    document.getElementById('video-duration').textContent = `æ—¶é•¿: æœªçŸ¥ (WebRecorderå½•åˆ¶)`;
                    console.log('âš ï¸ è§†é¢‘æ–‡ä»¶æ— æ—¶é•¿ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯WebRecorderå½•åˆ¶çš„æ–‡ä»¶');
                    
                    // æ˜¾ç¤ºWebRecorderæ–‡ä»¶æç¤º
                    showWebRecorderWarning();
                }
            });
            
            // ç›‘å¬åŠ è½½é”™è¯¯
            player.addEventListener('error', (e) => {
                console.error('âŒ è§†é¢‘åŠ è½½é”™è¯¯:', e);
                const error = player.error;
                let message = 'è§†é¢‘åŠ è½½å¤±è´¥';
                
                if (error) {
                    switch (error.code) {
                        case error.MEDIA_ERR_ABORTED:
                            message = 'è§†é¢‘åŠ è½½è¢«ä¸­æ­¢';
                            break;
                        case error.MEDIA_ERR_NETWORK:
                            message = 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è§†é¢‘';
                            break;
                        case error.MEDIA_ERR_DECODE:
                            message = 'è§†é¢‘è§£ç é”™è¯¯';
                            break;
                        case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            message = 'ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼';
                            break;
                    }
                }
                
                window.templateSystem.showError(`${message}: ${fileName}`);
            });
            
            // ç›‘å¬æ’­æ”¾å¼€å§‹
            player.addEventListener('play', () => {
                console.log('â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾');
                if (!hasValidDuration) {
                    // å¯¹äºæ²¡æœ‰æ—¶é•¿ä¿¡æ¯çš„è§†é¢‘ï¼Œå¼€å§‹è®¡æ—¶
                    startPlaybackTimer();
                }
            });
            
            // ç›‘å¬æ’­æ”¾æš‚åœ
            player.addEventListener('pause', () => {
                console.log('â¸ï¸ è§†é¢‘æš‚åœæ’­æ”¾');
                stopPlaybackTimer();
            });
            
            // ç›‘å¬æ’­æ”¾ç»“æŸ
            player.addEventListener('ended', () => {
                console.log('ğŸ è§†é¢‘æ’­æ”¾ç»“æŸ');
                stopPlaybackTimer();
            });
            
            // ç›‘å¬æ—¶é—´æ›´æ–°ï¼ˆç”¨äºæ˜¾ç¤ºå½“å‰æ’­æ”¾æ—¶é—´ï¼‰
            player.addEventListener('timeupdate', () => {
                if (hasValidDuration) {
                    // æœ‰æ—¶é•¿ä¿¡æ¯çš„æ­£å¸¸å¤„ç†
                    const current = formatDuration(player.currentTime);
                    const total = formatDuration(player.duration);
                    document.getElementById('video-duration').textContent = `${current} / ${total}`;
                } else {
                    // æ²¡æœ‰æ—¶é•¿ä¿¡æ¯ï¼Œåªæ˜¾ç¤ºå½“å‰æ’­æ”¾æ—¶é—´
                    const current = formatDuration(player.currentTime);
                    document.getElementById('video-duration').textContent = `å·²æ’­æ”¾: ${current}`;
                }
            });
        }
        
        let playbackTimer = null;
        
        // å¼€å§‹æ’­æ”¾è®¡æ—¶å™¨ï¼ˆç”¨äºWebRecorderæ–‡ä»¶ï¼‰
        function startPlaybackTimer() {
            stopPlaybackTimer(); // ç¡®ä¿æ²¡æœ‰é‡å¤çš„è®¡æ—¶å™¨
            
            const startTime = Date.now();
            playbackTimer = setInterval(() => {
                const player = document.getElementById('video-player');
                if (player && !player.paused) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ’­æ”¾è¿›åº¦æ˜¾ç¤º
                }
            }, 1000);
        }
        
        // åœæ­¢æ’­æ”¾è®¡æ—¶å™¨
        function stopPlaybackTimer() {
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
        }
        
        // æ˜¾ç¤ºWebRecorderæ–‡ä»¶è­¦å‘Š
        function showWebRecorderWarning() {
            const warningHtml = `
                <div class="alert alert-warning alert-dismissible fade show mt-2" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>æ³¨æ„ï¼š</strong>æ­¤è§†é¢‘æ–‡ä»¶ç”±WebRecorderå½•åˆ¶ï¼Œå¯èƒ½æ— æ³•æ˜¾ç¤ºå‡†ç¡®çš„æ—¶é•¿ä¿¡æ¯å’Œè¿›åº¦æ¡ã€‚æ’­æ”¾åŠŸèƒ½æ­£å¸¸ï¼Œä½†è¿›åº¦æ‹–æ‹½å¯èƒ½å—é™ã€‚
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const videoControls = document.getElementById('video-controls');
            if (videoControls && !videoControls.querySelector('.alert-warning')) {
                videoControls.insertAdjacentHTML('afterend', warningHtml);
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(event, downloadUrl, fileName) {
            event.stopPropagation(); // é˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡
            
            console.log('ğŸ“¥ å¼€å§‹ä¸‹è½½æ–‡ä»¶:', fileName);
            
            // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('âœ… ä¸‹è½½å¼€å§‹');
        }

        // ä¸‹è½½å½“å‰æ’­æ”¾çš„æ–‡ä»¶
        function downloadCurrentFile() {
            if (currentFileUrl && currentFileName) {
                downloadFile({ stopPropagation: () => {} }, currentFileUrl, currentFileName);
            }
        }

        // åˆ é™¤å½“å‰æ’­æ”¾çš„æ–‡ä»¶
        async function deleteCurrentFile() {
            if (!currentStudentId || !currentFileName) {
                window.templateSystem.showError('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${currentFileName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }

            try {
                window.templateSystem.showLoading('æ­£åœ¨åˆ é™¤æ–‡ä»¶...');
                
                const response = await fetch(`/api/files/${currentStudentId}/${encodeURIComponent(currentFileName)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    window.templateSystem.showSuccess('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                    
                    // æ¸…é™¤å½“å‰æ’­æ”¾çŠ¶æ€
                    currentStudentId = null;
                    currentFileName = null;
                    currentFileUrl = null;
                    
                    // éšè—æ’­æ”¾å™¨
                    document.getElementById('video-player').style.display = 'none';
                    document.getElementById('video-placeholder').style.display = 'block';
                    document.getElementById('video-controls').style.display = 'none';
                    document.getElementById('current-playing').style.display = 'none';
                    
                    // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                    setTimeout(() => {
                        loadRecordedFiles();
                    }, 1000);
                } else {
                    window.templateSystem.showError(data.message || 'åˆ é™¤æ–‡ä»¶å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                const message = error.response?.data?.message || error.message || 'åˆ é™¤æ–‡ä»¶å¤±è´¥';
                window.templateSystem.showError(message);
            } finally {
                window.templateSystem.hideLoading();
            }
        }

        // æ›´æ–°æ´»è·ƒæ–‡ä»¶é¡¹
        function updateActiveFileItem(studentId, fileName) {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ·»åŠ å½“å‰æ–‡ä»¶çš„æ´»è·ƒçŠ¶æ€
            const currentItem = document.querySelector(
                `[data-student-id="${studentId}"][data-file-name="${fileName}"]`
            );
            if (currentItem) {
                currentItem.classList.add('active');
            }
        }

        // æ˜¾ç¤ºå½“å‰æ’­æ”¾ä¿¡æ¯
        function showCurrentPlaying(studentId, fileName) {
            const studentData = recordedFiles[studentId];
            if (!studentData) return;
            
            document.getElementById('current-file-name').textContent = fileName;
            document.getElementById('current-student-info').textContent = 
                `${studentData.studentName} (${studentId})`;
            document.getElementById('current-playing').style.display = 'block';
        }

        // æ›´æ–°è§†é¢‘ä¿¡æ¯
        function updateVideoInfo(fileName) {
            document.getElementById('video-info').textContent = `æ–‡ä»¶: ${fileName}`;
            
            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            document.getElementById('video-duration').textContent = 'åŠ è½½ä¸­...';
            
            // æ·»åŠ æ–‡ä»¶ç±»å‹æç¤º
            if (fileName.includes('screen')) {
                document.getElementById('video-info').textContent += ' (å±å¹•å½•åˆ¶)';
            } else if (fileName.includes('camera')) {
                document.getElementById('video-info').textContent += ' (æ‘„åƒå¤´å½•åˆ¶)';
            }
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (isNaN(seconds)) return 'æœªçŸ¥';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const students = Object.keys(recordedFiles);
            let totalFiles = 0;
            let totalSizeBytes = 0;
            let lastModified = new Date(0);
            
            students.forEach(studentId => {
                const studentData = recordedFiles[studentId];
                totalFiles += studentData.files.length;
                
                studentData.files.forEach(file => {
                    // è§£ææ–‡ä»¶å¤§å°ï¼ˆä»æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ä¸­æå–ï¼‰
                    const sizeStr = file.size;
                    if (sizeStr.includes('MB')) {
                        totalSizeBytes += parseFloat(sizeStr) * 1024 * 1024;
                    } else if (sizeStr.includes('KB')) {
                        totalSizeBytes += parseFloat(sizeStr) * 1024;
                    } else if (sizeStr.includes('GB')) {
                        totalSizeBytes += parseFloat(sizeStr) * 1024 * 1024 * 1024;
                    }
                    
                    const fileDate = new Date(file.modificationTime);
                    if (fileDate > lastModified) {
                        lastModified = fileDate;
                    }
                });
            });
            
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('total-size').textContent = formatFileSize(totalSizeBytes);
            document.getElementById('last-updated').textContent = 
                lastModified.getTime() > 0 ? lastModified.toLocaleDateString('zh-CN') : '-';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('search-input').addEventListener('input', debounce(() => {
                renderFilesList();
            }, 300));
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const container = document.getElementById('files-container');
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                </div>
            `;
        }

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        async function refreshFiles() {
            console.log('ğŸ”„ åˆ·æ–°æ–‡ä»¶åˆ—è¡¨...');
            showLoading(true);
            
            try {
                await loadRecordedFiles();
                window.templateSystem.showSuccess('æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°');
                
            } catch (error) {
                console.error('âŒ åˆ·æ–°å¤±è´¥:', error);
                const message = error.message || 'åˆ·æ–°å¤±è´¥';
                window.templateSystem.showError(`åˆ·æ–°å¤±è´¥: ${message}`);
            } finally {
                showLoading(false);
            }
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.history.back();
        }

        // å½•åˆ¶çŠ¶æ€ç›‘æ§ç›¸å…³åŠŸèƒ½
        async function loadRecordingStatus() {
            try {
                const response = await fetch('/api/recording-status');
                if (response.data?.success) {
                    displayRecordingStatus(response.data.data);
                } else {
                    const data = await response.json();
                    if (data.success) {
                        displayRecordingStatus(data.data);
                    } else {
                        console.error('åŠ è½½å½•åˆ¶çŠ¶æ€æ•°æ®å¤±è´¥:', data.message);
                        document.getElementById('recording-status-container').innerHTML =
                            '<div class="alert alert-warning">åŠ è½½å½•åˆ¶çŠ¶æ€æ•°æ®å¤±è´¥</div>';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å½•åˆ¶çŠ¶æ€æ•°æ®å¤±è´¥:', error);
                document.getElementById('recording-status-container').innerHTML =
                    '<div class="alert alert-danger">ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½å½•åˆ¶çŠ¶æ€æ•°æ®</div>';
            }
        }

        function displayRecordingStatus(data) {
            const container = document.getElementById('recording-status-container');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— å½•åˆ¶çŠ¶æ€æ•°æ®</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>å­¦å·</th>
                                <th>æœ€åä¿®æ”¹æ—¶é—´</th>
                                <th>æ–‡ä»¶å¤§å°</th>
                                <th>çŠ¶æ€</th>
                                <th>æ—¶é—´å·®(ç§’)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(file => {
                const statusClass = file.isBelowThreshold ? 'text-success' : 'text-warning';
                const statusText = file.isBelowThreshold ? 'æ´»è·ƒ' : 'é™é»˜';
                const statusIcon = file.isBelowThreshold ? 'ğŸŸ¢' : 'ğŸŸ¡';

                html += `
                    <tr>
                        <td><strong>${file.studentId}</strong></td>
                        <td>${file.modificationTimeStr}</td>
                        <td>${file.fileSize}</td>
                        <td class="${statusClass}">
                            ${statusIcon} ${statusText}
                        </td>
                        <td>${Math.round(file.timeDiff)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        æ´»è·ƒï¼šæœ€è¿‘30ç§’å†…æœ‰æ–‡ä»¶æ›´æ–° | é™é»˜ï¼šè¶…è¿‡30ç§’æœªæ›´æ–° | è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼š5ç§’
                    </small>
                </div>
            `;

            container.innerHTML = html;
        }
    </script>
</body>
</html>