<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>ç›‘æ§ç•Œé¢</title>
</head>

<body id="page-top">
    <!-- å¯¼èˆªæ å’Œé¡µè„šå°†é€šè¿‡template.jsè‡ªåŠ¨æ·»åŠ  -->
    
    <section id="features">
        <div class="container-fluid text-center px-5 py-3">
            <div class="alert alert-warning">
                ç›‘æ§ç«¯è¿æ¥çŠ¶æ€ï¼š
                <button id="online-state-btn" class="btn btn-outline-dark">æœªè¿æ¥</button>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="container-fluid px-5 py-2">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ç³»ç»ŸçŠ¶æ€</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">æœåŠ¡å™¨è¿è¡Œæ—¶é—´</small>
                                    <div id="server-uptime" class="fw-bold">--</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">å†…å­˜ä½¿ç”¨</small>
                                    <div id="memory-usage" class="fw-bold">--</div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-4">
                                    <small class="text-muted">åœ¨çº¿ç”¨æˆ·</small>
                                    <div id="online-users" class="fw-bold text-success">--</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">å½•åˆ¶ä¸­</small>
                                    <div id="recording-users" class="fw-bold text-warning">--</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">æ€»è®¾å¤‡æ•°</small>
                                    <div id="total-devices" class="fw-bold text-info">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">åœ¨çº¿ç›‘è€ƒå‘˜</h6>
                        </div>
                        <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                            <div id="supervisors-list">
                                <small class="text-muted">æš‚æ— åœ¨çº¿ç›‘è€ƒå‘˜</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid text-center mb-4">
            <button class="btn btn-info" id="start-btn">å…¨ä½“å¼€å§‹å½•åˆ¶</button>
            <button class="btn btn-danger" id="finish-btn">å…¨ä½“åœæ­¢å½•åˆ¶</button>
            <button class="btn btn-success" id="notice-btn">å‘é€é€šçŸ¥</button>
            <button class="btn btn-warning" id="user-status-btn">ç”¨æˆ·ç®¡ç†</button>
            <button class="btn btn-warning" id="file-monitor-btn">æ–‡ä»¶ç®¡ç†</button>
            <button class="btn btn-primary" id="live-monitor-btn">å®æ—¶ç›‘æ§</button>
        </div>

        <!-- è€ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="container-fluid text-center mb-3" id="exam-info" style="display: none;">
            <div class="alert alert-info">
                <strong>è€ƒè¯•ä¿¡æ¯ï¼š</strong>
                <span id="exam-details"></span>
            </div>
        </div>

        <div class="col-10 container-fluid text-center">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">åºå·</th>
                        <th scope="col">å­¦å·</th>
                        <th scope="col">å§“å</th>
                        <th scope="col" id="exam-info-col" style="display: none;">è€ƒè¯•ä¿¡æ¯</th>
                        <th scope="col">åœ¨çº¿æ•°é‡</th>
                        <th id='screen-record' scope="col">å±å¹•å½•åˆ¶</th>
                        <th id='camera-record' scope="col">æ‘„åƒå¤´å½•åˆ¶</th>
                        <th scope="col">ä¸­æ–­æ¬¡æ•°</th>
                        <th scope="col">ç´¯è®¡æ—¶é•¿</th>
                        <th scope="col">ç¦æ­¢å‚åŠ è€ƒè¯•</th>
                        <th scope="col">å…è®¸æ–°IPç™»å½•</th>
                        <th scope="col">äº¤å·</th>

                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- å­¦ç”Ÿåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- ç”¨æˆ·ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal fade" id="userManagementModal" tabindex="-1" aria-labelledby="userManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userManagementModalLabel">ç”¨æˆ·çŠ¶æ€ç®¡ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ç¦ç”¨ç”¨æˆ·</h6>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="disableUserInput" placeholder="è¾“å…¥å­¦å·">
                                <button class="btn btn-danger" type="button" id="disableUserBtn">ç¦ç”¨</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>å¯ç”¨ç”¨æˆ·</h6>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="enableUserInput" placeholder="è¾“å…¥å­¦å·">
                                <button class="btn btn-success" type="button" id="enableUserBtn">å¯ç”¨</button>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>æç¤ºï¼š</strong>
                        <ul class="mb-0">
                            <li>ç¦ç”¨ç”¨æˆ·åï¼Œè¯¥ç”¨æˆ·å°†æ— æ³•ç™»å½•ç³»ç»Ÿ</li>
                            <li>å¯ç”¨ç”¨æˆ·åï¼Œè¯¥ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•ç³»ç»Ÿ</li>
                            <li>è¯·è¾“å…¥æ­£ç¡®çš„7ä½æ•°å­—å­¦å·</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/public/js/template.js"></script>
    <script>
        // ç­‰å¾…loggeråŠ è½½
        function waitForLogger() {
            return new Promise(resolve => {
                const checkLogger = () => {
                    if (window.logger) resolve();
                    else setTimeout(checkLogger, 100);
                };
                checkLogger();
            });
        }
        
        (async () => {
            await waitForLogger();
            window.logger.info('MonitorPage', 'ç›‘æ§é¡µé¢è„šæœ¬å¼€å§‹åŠ è½½...');
        })();

        let socket;
        let sessionUser;
        let videoConfig = {};
        let networkConfig = {};

        document.addEventListener('DOMContentLoaded', async () => {
            await waitForLogger();
            window.logger.info('MonitorPage', 'DOMå†…å®¹å·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–ç›‘æ§é¡µé¢...');
            
            // ç­‰å¾…æ¨¡æ¿ç³»ç»Ÿåˆå§‹åŒ–
            await new Promise(resolve => {
                const checkTemplate = () => {
                    const hasTemplateSystem = !!window.templateSystem;
                    const isInitialized = window.templateSystem?.isInitialized;

                    if (window.templateSystem && window.templateSystem.isInitialized) {
                        window.logger.debug('MonitorPage', 'æ¨¡æ¿ç³»ç»Ÿå·²å®Œå…¨åˆå§‹åŒ–');
                        resolve();
                    } else {
                        setTimeout(checkTemplate, 100);
                    }
                };
                checkTemplate();
            });

            // æ£€æŸ¥æƒé™ï¼š1=æ™®é€šç®¡ç†å‘˜ï¼Œ>=5=è¶…çº§ç®¡ç†å‘˜
            const userLevel = parseInt(window.templateSystem.sessionUser?.stu_userlevel || '0');
            window.logger.debug('MonitorPage', 'æ£€æŸ¥ç”¨æˆ·æƒé™', { 
                sessionUser: window.templateSystem.sessionUser, 
                userLevel 
            });

            if (!window.templateSystem.sessionUser || userLevel < 1) {
                window.logger.error('MonitorPage', 'æƒé™ä¸è¶³ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™');
                window.templateSystem.showError('è®¿é—®è¢«æ‹’ç»ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            window.logger.info('MonitorPage', 'æƒé™æ£€æŸ¥é€šè¿‡');

            // æ‰€æœ‰ç®¡ç†å‘˜éƒ½å¯ä»¥ä½¿ç”¨ç”¨æˆ·ç®¡ç†åŠŸèƒ½

            sessionUser = window.templateSystem.sessionUser;

            window.logger.debug('MonitorPage', 'å¼€å§‹åŠ è½½é…ç½®...');
            await loadConfiguration();

            window.logger.debug('MonitorPage', 'å¼€å§‹åŠ è½½å­¦ç”Ÿåˆ—è¡¨...');
            await loadStudentList();

            window.logger.debug('MonitorPage', 'å¼€å§‹åŠ è½½ç›‘è€ƒå‘˜åˆ—è¡¨...');
            await loadSupervisorsList();

            console.log('3ï¸âƒ£ è®¾ç½®Socketè¿æ¥...');
            setupSocketConnection();

            console.log('4ï¸âƒ£ è®¾ç½®äº‹ä»¶å¤„ç†å™¨...');
            setupEventHandlers();

            console.log('5ï¸âƒ£ å¯åŠ¨ç³»ç»ŸçŠ¶æ€æ›´æ–°...');
            startSystemStatusUpdates();

            console.log('âœ… ç›‘æ§é¡µé¢åˆå§‹åŒ–å®Œæˆï¼');
        });

        async function loadConfiguration() {
            console.log('=== å¼€å§‹åŠ è½½é…ç½® ===');
            try {
                console.log('ğŸ“¡ æ­£åœ¨è¯·æ±‚ /api/information...');
                const response = await axios.get('/api/information');
                console.log('ğŸ“¡ APIå“åº”:', response);

                if (response.data.success) {
                    videoConfig = response.data.data.videoConfig;
                    networkConfig = response.data.data.networkConfig;
                    console.log('âœ… é…ç½®åŠ è½½æˆåŠŸ:');
                    console.log('  - videoConfig:', videoConfig);
                    console.log('  - networkConfig:', networkConfig);
                } else {
                    console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:', response.data.message);
                    if (window.templateSystem) {
                        window.templateSystem.showError(`é…ç½®åŠ è½½å¤±è´¥: ${response.data.message}`);
                    }
                }
            } catch (error) {
                console.error('âŒ åŠ è½½é…ç½®å¼‚å¸¸:', error);
                console.error('  - é”™è¯¯ç±»å‹:', error.name);
                console.error('  - é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('  - å“åº”çŠ¶æ€:', error.response?.status);
                console.error('  - å“åº”æ•°æ®:', error.response?.data);

                if (window.templateSystem) {
                    window.templateSystem.showError('æ— æ³•åŠ è½½ç³»ç»Ÿé…ç½®ï¼Œç›‘æ§åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ');
                }
            }
            console.log('=== é…ç½®åŠ è½½å®Œæˆ ===');
        }

        async function loadStudentList() {
            try {
                window.templateSystem.showLoading('æ­£åœ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨...');

                const response = await axios.get('/api/stulist');
                if (response.data.success) {
                    // æ˜¾ç¤ºè€ƒè¯•ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯è€ƒè¯•æ¨¡å¼ï¼‰
                    if (response.data.data.examInfo) {
                        displayExamInfo(response.data.data.examInfo);
                    }
                    displayStudentList(response.data.data.stulist);
                } else {
                    window.templateSystem.showError(response.data.message);
                }
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
                window.templateSystem.showError('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥');
            } finally {
                window.templateSystem.hideLoading();
            }
        }

        async function loadSupervisorsList() {
            try {
                const response = await axios.get('/api/supervisors');
                if (response.data.success) {
                    updateSupervisorsList(response.data.data.supervisors);
                } else {
                    console.error('è·å–ç›‘è€ƒå‘˜åˆ—è¡¨å¤±è´¥:', response.data.message);
                }
            } catch (error) {
                console.error('åŠ è½½ç›‘è€ƒå‘˜åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        function displayExamInfo(examInfo) {
            const examInfoDiv = document.getElementById('exam-info');
            const examDetailsSpan = document.getElementById('exam-details');
            const examInfoCol = document.getElementById('exam-info-col');

            if (examInfo && examInfo.term && examInfo.cno && examInfo.eno) {
                examDetailsSpan.textContent = `å­¦æœŸ: ${examInfo.term} | è¯¾å·: ${examInfo.cno} | è€ƒè¯•ç¼–å·: ${examInfo.eno}`;
                examInfoDiv.style.display = 'block';
                examInfoCol.style.display = 'table-cell';
            } else {
                examInfoDiv.style.display = 'none';
                examInfoCol.style.display = 'none';
            }
        }

        function displayStudentList(students) {
            const tbody = document.getElementById('table-body');
            const examInfoCol = document.getElementById('exam-info-col');
            const isExamMode = examInfoCol.style.display !== 'none';
            const colSpan = isExamMode ? 14 : 13;

            if (!students || students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-muted">æš‚æ— å­¦ç”Ÿæ•°æ®</td></tr>`;
                return;
            }

            let html = '';
            students.forEach((student, index) => {
                // ç”Ÿæˆå”¯ä¸€çš„è¡ŒIDï¼Œæ”¯æŒå¤šåœºè€ƒè¯•
                const uniqueId = isExamMode ?
                    `${student.exam_term}-${student.exam_cno}-${student.exam_no}-${student.sno}` :
                    student.sno;

                html += `
                    <tr data-unique-id="${uniqueId}">
                        <td>${index + 1}</td>
                        <td>${student.sno}</td>
                        <td>${student.name}</td>`;

                // å¦‚æœæ˜¯è€ƒè¯•æ¨¡å¼ï¼Œæ·»åŠ è€ƒè¯•ä¿¡æ¯åˆ—
                if (isExamMode) {
                    html += `<td>${student.exam_term || ''}-${student.exam_cno || ''}-${student.exam_no || ''}</td>`;
                }

                html += `<td id="${uniqueId}-online">0</td>
                        <td class="screen" id="${uniqueId}-screen">æœªå½•åˆ¶</td>
                        <td class="camera" id="${uniqueId}-camera">æœªå½•åˆ¶</td>
                        <td class="interruptions" id="${uniqueId}-interruptions">0</td>
                        <td class="totalTime" id="${uniqueId}-totalTime">0ç§’</td>
                        <td class="exam-forbidden" id="${uniqueId}-exam-forbidden">
                            <button class="btn btn-sm btn-outline-danger" onclick="manageStudent('${student.sno}', 'forbidden', 1, '${uniqueId}')">ç¦æ­¢</button>
                            <button class="btn btn-sm btn-outline-success" onclick="manageStudent('${student.sno}', 'forbidden', 0, '${uniqueId}')">å…è®¸</button>
                        </td>
                        <td class="new-ip" id="${uniqueId}-new-ip">
                            <button class="btn btn-sm btn-outline-success" onclick="manageStudent('${student.sno}', 'new_ip', 1, '${uniqueId}')">å…è®¸</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="manageStudent('${student.sno}', 'new_ip', 0, '${uniqueId}')">ç¦æ­¢</button>
                        </td>
                        <td class="submit-exam" id="${uniqueId}-submit-exam">
                            <button class="btn btn-sm btn-outline-primary" onclick="manageStudent('${student.sno}', 'submit', 1, '${uniqueId}')">äº¤å·</button>
                        </td>

                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function setupSocketConnection() {
            if (!networkConfig.socketPort) {
                console.error('Socketç«¯å£æœªé…ç½®');
                return;
            }

            // ä½¿ç”¨å½“å‰é¡µé¢çš„hostï¼Œç¡®ä¿ä¸æœåŠ¡å™¨åœ°å€ä¸€è‡´
            const currentHost = window.location.hostname;
            const socketUrl = `https://${currentHost}:${networkConfig.socketPort}`;

            socket = io(socketUrl, {
                rejectUnauthorized: false,
                timeout: 30000,  // å¢åŠ è¿æ¥è¶…æ—¶æ—¶é—´
                forceNew: true,
                transports: ['polling', 'websocket'],
                upgrade: true,
                upgradeTimeout: 30000,  // å¢åŠ å‡çº§è¶…æ—¶æ—¶é—´
                rememberUpgrade: true,
                withCredentials: true
            });

            socket.on('connect', () => {
                document.getElementById('online-state-btn').textContent = 'å·²è¿æ¥';
                document.getElementById('online-state-btn').className = 'btn btn-outline-success';

                if (window.templateSystem) {
                    window.templateSystem.showSuccess('ç›‘æ§ç«¯è¿æ¥æˆåŠŸ');
                }

                // è¿æ¥æˆåŠŸåè¿›è¡Œç®¡ç†å‘˜è®¤è¯
                socket.emit('auth', {
                    userId: sessionUser.stu_no,
                    userType: 'admin'
                }, (response) => {
                    if (response && response.success) {
                        console.log('ç®¡ç†å‘˜è®¤è¯æˆåŠŸ:', response.data);
                        // è®¤è¯æˆåŠŸåè¯·æ±‚å½“å‰çŠ¶æ€
                        requestCurrentState();
                        // åˆ·æ–°ç›‘è€ƒå‘˜åˆ—è¡¨ï¼ˆå› ä¸ºè‡ªå·±ç°åœ¨åœ¨çº¿äº†ï¼‰
                        loadSupervisorsList();
                    } else {
                        console.error('ç®¡ç†å‘˜è®¤è¯å¤±è´¥:', response);
                        if (window.templateSystem) {
                            window.templateSystem.showError('ç®¡ç†å‘˜è®¤è¯å¤±è´¥');
                        }
                    }
                });
            });

            socket.on('disconnect', (reason) => {
                document.getElementById('online-state-btn').textContent = 'æœªè¿æ¥';
                document.getElementById('online-state-btn').className = 'btn btn-outline-dark';

                if (window.templateSystem) {
                    window.templateSystem.showWarning(`ç›‘æ§ç«¯è¿æ¥æ–­å¼€: ${reason}`);
                }
            });

            socket.on('connect_error', (error) => {
                document.getElementById('online-state-btn').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('online-state-btn').className = 'btn btn-outline-danger';

                // æ˜¾ç¤ºé”™è¯¯æç¤º
                if (window.templateSystem) {
                    window.templateSystem.showError(`ç›‘æ§ç«¯è¿æ¥å¤±è´¥: ${error.message || error.description || 'ç½‘ç»œé”™è¯¯'}`);
                }
            });

            socket.on('status', (data) => {
                updateStudentStates(data.users);
            });

            socket.on('reconnect', () => {
                console.log('Socketé‡è¿æˆåŠŸï¼Œé‡æ–°è®¤è¯...');
                document.getElementById('online-state-btn').textContent = 'é‡æ–°è®¤è¯ä¸­';
                document.getElementById('online-state-btn').className = 'btn btn-outline-warning';

                // é‡è¿æˆåŠŸåé‡æ–°è®¤è¯
                socket.emit('auth', {
                    userId: sessionUser.stu_no,
                    userType: 'admin'
                }, (response) => {
                    if (response && response.success) {
                        console.log('é‡è¿åç®¡ç†å‘˜è®¤è¯æˆåŠŸ:', response.data);
                        document.getElementById('online-state-btn').textContent = 'å·²è¿æ¥';
                        document.getElementById('online-state-btn').className = 'btn btn-outline-success';
                        
                        if (window.templateSystem) {
                            window.templateSystem.showSuccess('é‡è¿å¹¶è®¤è¯æˆåŠŸ');
                        }
                        
                        // è®¤è¯æˆåŠŸåè¯·æ±‚å½“å‰çŠ¶æ€
                        requestCurrentState();
                        // åˆ·æ–°ç›‘è€ƒå‘˜åˆ—è¡¨
                        loadSupervisorsList();
                    } else {
                        console.error('é‡è¿åç®¡ç†å‘˜è®¤è¯å¤±è´¥:', response);
                        document.getElementById('online-state-btn').textContent = 'è®¤è¯å¤±è´¥';
                        document.getElementById('online-state-btn').className = 'btn btn-outline-danger';
                        
                        if (window.templateSystem) {
                            window.templateSystem.showError('é‡è¿è®¤è¯å¤±è´¥');
                        }
                    }
                });
            });
        }

        function requestCurrentState() {
            // è¯·æ±‚æœåŠ¡å™¨å‘é€å½“å‰çŠ¶æ€
            if (socket && socket.connected) {
                socket.emit('status:request');
            }
        }

        function updateStudentStates(states) {
            let totalDevices = 0;

            Object.values(states).forEach(user => {
                // åªå¤„ç†å­¦ç”Ÿç”¨æˆ·ï¼Œè·³è¿‡ç®¡ç†å‘˜
                if (user.stu_userlevel !== '0') {
                    return; // è·³è¿‡ç®¡ç†å‘˜ç”¨æˆ·
                }

                const studentId = user.stu_no;

                // æŸ¥æ‰¾å¯¹åº”çš„è¡ŒIDï¼ˆå¯èƒ½æ˜¯ç®€å•çš„å­¦å·ï¼Œä¹Ÿå¯èƒ½æ˜¯è€ƒè¯•æ¨¡å¼çš„å¤åˆIDï¼‰
                let rowElement = findStudentRow(studentId);
                if (!rowElement) {
                    // å¦‚æœæ‰¾ä¸åˆ°è¡Œå…ƒç´ ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦åŠ¨æ€æ·»åŠ çš„å­¦ç”Ÿ
                    if (user.online > 0 || hasRecordingActivity(user)) {
                        console.log(`åŠ¨æ€æ·»åŠ åœ¨çº¿å­¦ç”Ÿ ${studentId} åˆ°ç›‘æ§åˆ—è¡¨`);
                        addDynamicStudentRow(user);
                        rowElement = findStudentRow(studentId);
                    }
                    
                    if (!rowElement) {
                        // ä»ç„¶æ‰¾ä¸åˆ°ï¼Œå¯èƒ½æ˜¯ä¸åœ¨ç›‘æ§èŒƒå›´å†…çš„å­¦ç”Ÿï¼Œè·³è¿‡
                        console.log(`å­¦ç”Ÿ ${studentId} ä¸åœ¨å½“å‰ç›‘æ§åˆ—è¡¨ä¸­`);
                        return;
                    }
                }

                const uniqueId = rowElement.getAttribute('data-unique-id');

                updateStudentCell(uniqueId, 'online', user.online || 0);

                // æ£€æŸ¥å½•åˆ¶çŠ¶æ€
                const screenRecording = getRecordingStatus(user, 'screen');
                const cameraRecording = getRecordingStatus(user, 'camera');

                updateStudentCell(uniqueId, 'screen', screenRecording);
                updateStudentCell(uniqueId, 'camera', cameraRecording);
                updateStudentCell(uniqueId, 'interruptions', user.interruptions || 0);
                updateStudentCell(uniqueId, 'totalTime', formatTime(Math.floor((user.accumulatedDuration || 0) / 1000)));

                // ç»Ÿè®¡è®¾å¤‡æ•°é‡ï¼ˆç°åœ¨éƒ½æ˜¯å­¦ç”Ÿç”¨æˆ·ï¼Œç›´æ¥ç»Ÿè®¡ï¼‰
                const screenDevices = user.recordList && user.recordList.screen ? Object.keys(user.recordList.screen).length : 0;
                const cameraDevices = user.recordList && user.recordList.camera ? Object.keys(user.recordList.camera).length : 0;
                totalDevices += screenDevices + cameraDevices;
            });

            // æ›´æ–°æ€»è®¾å¤‡æ•°æ˜¾ç¤º
            const totalDevicesElement = document.getElementById('total-devices');
            if (totalDevicesElement) {
                totalDevicesElement.textContent = totalDevices;
            }
        }

        function findStudentRow(studentId) {
            // é¦–å…ˆå°è¯•ç›´æ¥åŒ¹é…å­¦å·
            let row = document.querySelector(`tr[data-unique-id="${studentId}"]`);
            if (row) return row;

            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é…åŒ…å«å­¦å·çš„å¤åˆID
            const allRows = document.querySelectorAll('tr[data-unique-id]');
            for (const row of allRows) {
                const uniqueId = row.getAttribute('data-unique-id');
                if (uniqueId && uniqueId.endsWith(`-${studentId}`)) {
                    return row;
                }
            }

            return null;
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å½•åˆ¶æ´»åŠ¨
        function hasRecordingActivity(user) {
            if (!user.recordList) return false;
            
            const screenDevices = user.recordList.screen ? Object.keys(user.recordList.screen).length : 0;
            const cameraDevices = user.recordList.camera ? Object.keys(user.recordList.camera).length : 0;
            
            return screenDevices > 0 || cameraDevices > 0;
        }

        // åŠ¨æ€æ·»åŠ å­¦ç”Ÿè¡Œåˆ°è¡¨æ ¼
        function addDynamicStudentRow(user) {
            const tbody = document.getElementById('table-body');
            const examInfoCol = document.getElementById('exam-info-col');
            const isExamMode = examInfoCol.style.display !== 'none';
            
            // è®¡ç®—å½“å‰è¡Œæ•°ï¼Œç”¨äºåºå·
            const currentRows = tbody.querySelectorAll('tr').length;
            const uniqueId = user.stu_no; // åŠ¨æ€æ·»åŠ çš„ç”¨æˆ·ä½¿ç”¨ç®€å•å­¦å·ä½œä¸ºID
            
            let html = `
                <tr data-unique-id="${uniqueId}" class="dynamic-student">
                    <td>${currentRows + 1}</td>
                    <td>${user.stu_no}</td>
                    <td>${user.stu_name} <span class="badge bg-info">åœ¨çº¿</span></td>`;

            // å¦‚æœæ˜¯è€ƒè¯•æ¨¡å¼ï¼Œæ·»åŠ ç©ºçš„è€ƒè¯•ä¿¡æ¯åˆ—
            if (isExamMode) {
                html += `<td class="text-muted">åŠ¨æ€ç”¨æˆ·</td>`;
            }

            html += `<td id="${uniqueId}-online">0</td>
                    <td class="screen" id="${uniqueId}-screen">æœªå½•åˆ¶</td>
                    <td class="camera" id="${uniqueId}-camera">æœªå½•åˆ¶</td>
                    <td class="interruptions" id="${uniqueId}-interruptions">0</td>
                    <td class="totalTime" id="${uniqueId}-totalTime">0ç§’</td>
                    <td class="exam-forbidden" id="${uniqueId}-exam-forbidden">
                        <button class="btn btn-sm btn-outline-danger" onclick="manageStudent('${user.stu_no}', 'forbidden', 1, '${uniqueId}')">ç¦æ­¢</button>
                        <button class="btn btn-sm btn-outline-success" onclick="manageStudent('${user.stu_no}', 'forbidden', 0, '${uniqueId}')">å…è®¸</button>
                    </td>
                    <td class="new-ip" id="${uniqueId}-new-ip">
                        <button class="btn btn-sm btn-outline-success" onclick="manageStudent('${user.stu_no}', 'new_ip', 1, '${uniqueId}')">å…è®¸</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="manageStudent('${user.stu_no}', 'new_ip', 0, '${uniqueId}')">ç¦æ­¢</button>
                    </td>
                    <td class="submit-exam" id="${uniqueId}-submit-exam">
                        <button class="btn btn-sm btn-outline-primary" onclick="manageStudent('${user.stu_no}', 'submit', 1, '${uniqueId}')">äº¤å·</button>
                    </td>
                </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', html);
        }

        function getRecordingStatus(user, type) {
            if (!user.recordList || !user.recordList[type]) {
                return 'æœªå½•åˆ¶';
            }

            const recordList = user.recordList[type];
            const activeRecords = Object.keys(recordList).length;

            if (activeRecords === 0) {
                return 'æœªå½•åˆ¶';
            } else if (activeRecords === 1) {
                return 'å½•åˆ¶ä¸­';
            } else {
                return `å½•åˆ¶ä¸­(${activeRecords}ä¸ªè®¾å¤‡)`;
            }
        }



        function updateStudentCell(studentId, field, value) {
            const cell = document.getElementById(`${studentId}-${field}`);
            if (cell) {
                cell.textContent = value;
            }
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}å°æ—¶${minutes}åˆ†${secs}ç§’`;
        }

        function setupEventHandlers() {
            // å…¨ä½“å¼€å§‹å½•åˆ¶
            document.getElementById('start-btn').addEventListener('click', () => {
                sendCommand('record', { action: 'start' });
            });

            // å…¨ä½“åœæ­¢å½•åˆ¶
            document.getElementById('finish-btn').addEventListener('click', () => {
                sendCommand('record', { action: 'stop' });
            });

            // å‘é€é€šçŸ¥
            document.getElementById('notice-btn').addEventListener('click', () => {
                const message = prompt('è¯·è¾“å…¥é€šçŸ¥å†…å®¹:');
                if (message) {
                    sendCommand('notice', { target: 'all', message });
                }
            });

            // ç”¨æˆ·ç®¡ç†
            document.getElementById('user-status-btn').addEventListener('click', () => {
                openUserManagementModal();
            });

            // æ–‡ä»¶ç®¡ç†
            document.getElementById('file-monitor-btn').addEventListener('click', () => {
                window.open('/history', '_blank', 'width=1400,height=900');
            });

            // å®æ—¶ç›‘æ§é¢æ¿
            document.getElementById('live-monitor-btn').addEventListener('click', () => {
                window.open('/live', '_blank', 'width=1400,height=900');
            });

            // ç”¨æˆ·çŠ¶æ€ç®¡ç†äº‹ä»¶
            document.getElementById('disableUserBtn').addEventListener('click', () => {
                const studentId = document.getElementById('disableUserInput').value.trim();
                if (studentId) {
                    updateUserStatus(studentId, '0');
                    document.getElementById('disableUserInput').value = '';
                }
            });
            
            document.getElementById('enableUserBtn').addEventListener('click', () => {
                const studentId = document.getElementById('enableUserInput').value.trim();
                if (studentId) {
                    updateUserStatus(studentId, '1');
                    document.getElementById('enableUserInput').value = '';
                }
            });
        }

        async function sendCommand(type, data) {
            try {
                const response = await axios.post('/api/emit', { type, data });
                if (response.data.success) {
                    window.templateSystem.showSuccess(response.data.message);
                } else {
                    window.templateSystem.showError(response.data.message);
                }
            } catch (error) {
                console.error('å‘é€å‘½ä»¤å¤±è´¥:', error);
                window.templateSystem.showError('å‘é€å‘½ä»¤å¤±è´¥');
            }
        }

        async function updateUserStatus(studentId, status) {
            if (!studentId.match(/^\d{7}$/)) {
                window.templateSystem.showError('è¯·è¾“å…¥æ­£ç¡®çš„7ä½æ•°å­—å­¦å·');
                return;
            }
            
            const statusText = status === '1' ? 'å¯ç”¨' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${statusText}å­¦å· ${studentId} å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await axios.post('/api/user-status', { id: studentId, status });
                if (response.data.success) {
                    window.templateSystem.showSuccess(response.data.message);
                    // é‡æ–°åŠ è½½å­¦ç”Ÿåˆ—è¡¨
                    setTimeout(() => {
                        loadStudentList();
                    }, 1000);
                } else {
                    window.templateSystem.showError(response.data.message);
                }
            } catch (error) {
                console.error('ä¿®æ”¹ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                window.templateSystem.showError('ä¿®æ”¹ç”¨æˆ·çŠ¶æ€å¤±è´¥');
            }
        }
        
        function openUserManagementModal() {
            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            modal.show();
        }

        async function manageStudent(studentId, type, operation, uniqueId = null) {
            try {
                const requestData = {
                    srcId: studentId,
                    type: type,
                    op: operation
                };

                // å¦‚æœæ˜¯è€ƒè¯•æ¨¡å¼ï¼Œæ·»åŠ è€ƒè¯•ä¿¡æ¯
                if (uniqueId && uniqueId.includes('-')) {
                    const parts = uniqueId.split('-');
                    if (parts.length >= 4) {
                        requestData.exam_term = parts[0];
                        requestData.exam_cno = parts[1];
                        requestData.exam_no = parts[2];
                    }
                }

                const response = await axios.post('/api/manage', requestData);
                if (response.data.success) {
                    window.templateSystem.showSuccess('æ“ä½œæˆåŠŸ');
                } else {
                    window.templateSystem.showError(response.data.message);
                }
            } catch (error) {
                console.error('ç®¡ç†æ“ä½œå¤±è´¥:', error);
                window.templateSystem.showError('ç®¡ç†æ“ä½œå¤±è´¥');
            }
        }



        // ç³»ç»ŸçŠ¶æ€æ›´æ–°åŠŸèƒ½
        async function updateSystemStatus() {
            try {
                const response = await axios.get('/api/system-status');
                if (response.data.success) {
                    const data = response.data.data;

                    // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                    document.getElementById('server-uptime').textContent = formatUptime(data.system.uptime);
                    document.getElementById('memory-usage').textContent = formatMemory(data.system.memory.heapUsed, data.system.totalMemory);
                    document.getElementById('online-users').textContent = data.userStats.online;
                    document.getElementById('recording-users').textContent = data.userStats.recording;

                    // æ›´æ–°ç›‘è€ƒå‘˜åˆ—è¡¨
                    updateSupervisorsList(data.supervisors);
                }
            } catch (error) {
                console.error('æ›´æ–°ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (days > 0) {
                return `${days}å¤©${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            } else if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            } else {
                return `${minutes}åˆ†é’Ÿ`;
            }
        }

        function formatMemory(used, total) {
            const usedMB = Math.round(used / 1024 / 1024);
            const totalMB = Math.round(total / 1024 / 1024);
            const percentage = Math.round((used / total) * 100);
            return `${usedMB}MB / ${totalMB}MB (${percentage}%)`;
        }

        function updateSupervisorsList(supervisors) {
            const container = document.getElementById('supervisors-list');

            if (!supervisors || supervisors.length === 0) {
                container.innerHTML = '<small class="text-muted">æš‚æ— åœ¨çº¿ç›‘è€ƒå‘˜</small>';
                return;
            }

            let html = '';
            supervisors.forEach(supervisor => {
                const levelText = supervisor.stu_userlevel === '5' ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜';
                const badgeClass = supervisor.stu_userlevel === '5' ? 'bg-danger' : 'bg-primary';
                const loginTime = supervisor.loginTime ? formatLoginTime(supervisor.loginTime) : 'æœªçŸ¥';
                const ipAddress = supervisor.lastIP || 'æœªçŸ¥';

                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">${supervisor.stu_name} (${supervisor.stu_no})</div>
                                <span class="badge ${badgeClass}">${levelText}</span>
                                <span class="badge bg-success ms-1">åœ¨çº¿</span>
                            </div>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted d-block">ç™»å½•æ—¶é—´: ${loginTime}</small>
                            <small class="text-muted d-block">IPåœ°å€: ${ipAddress}</small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function formatLoginTime(loginTime) {
            try {
                const date = new Date(loginTime);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);

                if (diffMins < 1) {
                    return 'åˆšåˆš';
                } else if (diffMins < 60) {
                    return `${diffMins}åˆ†é’Ÿå‰`;
                } else if (diffHours < 24) {
                    return `${diffHours}å°æ—¶å‰`;
                } else {
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
            } catch (error) {
                return 'æœªçŸ¥';
            }
        }

        function startSystemStatusUpdates() {
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateSystemStatus();

            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€
            setInterval(updateSystemStatus, 30000);
        }


    </script>
</body>

</html>